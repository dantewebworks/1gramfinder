<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1Gram Finder</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">1Gram Finder</h1>
        
        <!-- Tab Navigation -->
        <div class="border-b border-gray-200 mb-6">
            <nav class="-mb-px flex space-x-8">
                <button onclick="switchTab('search')" id="search-tab" class="tab-btn py-2 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600">
                    Search
                </button>
                <button onclick="switchTab('places')" id="places-tab" class="tab-btn py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    Google Places – No Website Finder
                </button>
                <button onclick="switchTab('history')" id="history-tab" class="tab-btn py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    History
                </button>

                <button onclick="switchTab('settings')" id="settings-tab" class="tab-btn py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    Settings
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <!-- Search Tab -->
        <div id="search-content" class="tab-content">
            <!-- Search Settings -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">Search Configuration</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Maximum Results per Search
                            <span class="text-xs text-gray-500 ml-2">(Leave blank for unlimited)</span>
                        </label>
                        <input type="number" id="maxResults" placeholder="e.g., 50" min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Current Limit Status</label>
                        <div id="limitStatus" class="px-3 py-2 bg-gray-50 border border-gray-200 rounded-md">
                            <span id="limitStatusText" class="text-sm text-gray-700">No limit set (unlimited results)</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Location Selection with Countries and Cities -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Select Locations</h2>
                    <div class="flex gap-2">
                        <button id="selectAllCitiesBtn" class="text-xs bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">
                            Select All Visible
                        </button>
                        <button id="deselectAllCitiesBtn" class="text-xs bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600">
                            Deselect All
                        </button>
                    </div>
                </div>
                <div class="mb-3">
                    <span class="text-sm text-gray-600">Selected Cities: </span>
                    <span id="selectedCitiesCount" class="font-medium text-blue-600">0</span>
                </div>
                <div id="countriesContainer" class="space-y-2 max-h-96 overflow-y-auto">
                    <!-- Countries and cities will be populated here -->
                </div>
            </div>

            <!-- Niche Selection -->
            <div id="niche-selection" class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">Select Niches</h2>
                <div class="niche-buttons flex flex-wrap gap-2 mb-3">
                    <!-- Niches will be dynamically populated here -->
                </div>
                <div id="selectedNiches" class="text-sm">
                    <span class="font-medium text-gray-700">Selected Niches:</span>
                    <span id="selectedNichesList" class="text-blue-600">None</span>
                </div>
                <p class="text-xs text-gray-500 mt-3">Click niches to toggle selection (multiple allowed), then click Search to run queries</p>
            </div>

            <!-- Nano Banana Niches Section -->
            <div id="nano-niche-selection" class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold">Nano Banana Niches</h2>
                    <button id="nanoToggleBtn" class="text-xs bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600">Show/Hide</button>
                </div>
                <div id="nanoNicheContent" class="hidden">
                    <div class="nano-niche-buttons flex flex-wrap gap-2 mb-3">
                        <!-- Nano Niches will be dynamically populated here -->
                    </div>
                    <div id="selectedNanoNiches" class="text-sm">
                        <span class="font-medium text-gray-700">Selected Nano Niches:</span>
                        <span id="selectedNanoNichesList" class="text-blue-600">None</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-3">Click a niche to auto-run searches across selected cities</p>
                </div>
            </div>

            <!-- Search Button -->
            <div class="text-center mb-6">
                <button id="searchBtn" class="bg-green-600 text-white px-8 py-3 rounded-md hover:bg-green-700 transition duration-200 text-lg font-semibold">
                    Search Instagram Usernames
                </button>
                <p class="text-xs text-gray-500 mt-2">Click to start searching with selected niches and locations</p>
            </div>

            <!-- Info/Alert Messages -->
            <div id="infoMessage" class="mb-6 hidden">
                <div id="infoContent" class="rounded-lg p-4">
                    <p id="infoText" class="text-sm"></p>
                </div>
            </div>

            <!-- Results -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Current Search Results</h2>
                    <div class="flex gap-2 items-center">
                        <span id="resultCount" class="text-gray-600"></span>
                        <button id="exportCurrentBtn" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition duration-200 hidden">
                            Export Current
                        </button>
                    </div>
                </div>
                <div id="resultsContainer" class="max-h-96 overflow-y-auto">
                    <p class="text-gray-500 text-center py-8">No results yet. Configure API and start searching.</p>
                </div>
            </div>
        </div>

        <!-- Google Places No-Website Finder Tab -->
        <div id="places-content" class="tab-content hidden">
            <!-- Search Settings -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">Google Places – Search Configuration</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Maximum Results per Query
                            <span class="text-xs text-gray-500 ml-2">(Default 20; blank uses default)</span>
                        </label>
                        <input type="number" id="placesMaxResults" placeholder="e.g., 30" min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Current Limit Status</label>
                        <div id="placesLimitStatus" class="px-3 py-2 bg-gray-50 border border-gray-200 rounded-md">
                            <span id="placesLimitStatusText" class="text-sm text-gray-700">Default limit (30 results per query)</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Location Selection with Countries and Cities (Places) -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Select Locations</h2>
                    <div class="flex gap-2">
                        <button id="selectAllPlacesCitiesBtn" class="text-xs bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">
                            Select All Visible
                        </button>
                        <button id="deselectAllPlacesCitiesBtn" class="text-xs bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600">
                            Deselect All
                        </button>
                    </div>
                </div>
                <div class="mb-3">
                    <span class="text-sm text-gray-600">Selected Cities: </span>
                    <span id="selectedPlacesCitiesCount" class="font-medium text-blue-600">0</span>
                </div>
                <div id="placesCountriesContainer" class="space-y-2 max-h-96 overflow-y-auto">
                    <!-- Countries and cities will be populated here -->
                </div>
            </div>

            <!-- Niche Selection (Places) -->
            <div id="places-niche-selection" class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">Select Niches</h2>
                <div class="places-niche-buttons flex flex-wrap gap-2 mb-3">
                    <!-- Niches will be dynamically populated here -->
                </div>
                <div id="selectedPlacesNiches" class="text-sm">
                    <span class="font-medium text-gray-700">Selected Niches:</span>
                    <span id="selectedPlacesNichesList" class="text-blue-600">None</span>
                </div>
                <p class="text-xs text-gray-500 mt-3">Click niches to toggle selection (multiple allowed), then click Search to run queries</p>
            </div>

            <!-- Search Button (Places) -->
            <div class="text-center mb-6">
                <button id="placesSearchBtn" class="bg-green-600 text-white px-8 py-3 rounded-md hover:bg-green-700 transition duration-200 text-lg font-semibold">
                    Search Google Places – No Website
                </button>
                <p class="text-xs text-gray-500 mt-2">Press Search to start Places queries</p>
            </div>

            <!-- Info/Alert Messages (Places) -->
            <div id="placesInfoMessage" class="mb-6 hidden">
                <div id="placesInfoContent" class="rounded-lg p-4">
                    <p id="placesInfoText" class="text-sm"></p>
                </div>
            </div>

            <!-- Results (Places) -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Google Places Results (No Website)</h2>
                    <div class="flex gap-2 items-center">
                        <span id="placesResultCount" class="text-gray-600"></span>
                        <button id="placesExportCurrentBtn" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition duration-200 hidden">
                            Export Current
                        </button>
                    </div>
                </div>
                <div id="placesResultsContainer" class="max-h-96 overflow-y-auto">
                    <p class="text-gray-500 text-center py-8">No results yet. Configure API and start searching.</p>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="history-content" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Search History</h2>
                    <div class="flex gap-2">
                        <button id="exportAllBtn" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition duration-200 hidden">
                            Export All History
                        </button>
                        <button id="clearHistoryBtn" class="text-sm bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition duration-200 hidden">
                            Clear History
                        </button>
                    </div>
                </div>
                <div id="searchHistory" class="space-y-2 max-h-screen overflow-y-auto">
                    <p class="text-gray-500">No searches performed yet.</p>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-content" class="tab-content hidden">
            <!-- API Configuration -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">API Configuration</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Google API Key</label>
                        <input type="text" id="apiKey" placeholder="Enter your Google API Key" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Search Engine ID (CX)</label>
                        <input type="text" id="searchEngineId" placeholder="Enter your Search Engine ID" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Google Places API Key</label>
                        <input type="text" id="placesApiKey" placeholder="Enter your Google Places API Key" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="mt-4 flex justify-between items-center">
                    <p class="text-xs text-green-600" id="apiSaveStatus"></p>
                    <button id="clearAllDataBtn" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition duration-200 text-sm">
                        Clear All Saved Data
                    </button>
                </div>
            </div>

            <!-- Data Management -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">Data Management</h2>
                <div class="space-y-3">
                    <div class="flex justify-between items-center py-2 border-b">
                        <div>
                            <p class="font-medium">Total Results in History</p>
                            <p class="text-sm text-gray-600" id="totalResultsStored">0 results</p>
                        </div>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b">
                        <div>
                            <p class="font-medium">Search Sessions</p>
                            <p class="text-sm text-gray-600" id="totalSessions">0 sessions</p>
                        </div>
                    </div>
                    <div class="flex justify-between items-center py-2">
                        <div>
                            <p class="font-medium">Storage Status</p>
                            <p class="text-sm text-gray-600">All data is saved locally in your browser</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <script>
        // ========================================
        // COUNTRIES AND CITIES DATASET WITH STATES
        // ========================================
        const countriesAndCities = {
            "United States": {
                "New York City": "New York", "Los Angeles": "California", "Chicago": "Illinois", 
                "Houston": "Texas", "Phoenix": "Arizona", "Philadelphia": "Pennsylvania", 
                "San Antonio": "Texas", "San Diego": "California", "Dallas": "Texas", 
                "San Jose": "California", "Austin": "Texas", "Jacksonville": "Florida", 
                "Fort Worth": "Texas", "Columbus": "Ohio", "San Francisco": "California", 
                "Charlotte": "North Carolina", "Indianapolis": "Indiana", "Seattle": "Washington", 
                "Denver": "Colorado", "Washington DC": "District of Columbia", "Boston": "Massachusetts", 
                "El Paso": "Texas", "Detroit": "Michigan", "Nashville": "Tennessee", 
                "Portland": "Oregon", "Memphis": "Tennessee", "Oklahoma City": "Oklahoma", 
                "Las Vegas": "Nevada", "Louisville": "Kentucky", "Baltimore": "Maryland", 
                "Milwaukee": "Wisconsin", "Albuquerque": "New Mexico", "Tucson": "Arizona", 
                "Fresno": "California", "Mesa": "Arizona", "Sacramento": "California", 
                "Atlanta": "Georgia", "Kansas City": "Missouri", "Colorado Springs": "Colorado", 
                "Miami": "Florida", "Raleigh": "North Carolina", "Omaha": "Nebraska", 
                "Long Beach": "California", "Virginia Beach": "Virginia", "Oakland": "California", 
                "Minneapolis": "Minnesota", "Tulsa": "Oklahoma", "Arlington": "Texas", 
                "Tampa": "Florida", "New Orleans": "Louisiana", "Wichita": "Kansas", 
                "Cleveland": "Ohio", "Bakersfield": "California", "Aurora": "Colorado", 
                "Anaheim": "California", "Honolulu": "Hawaii", "Santa Ana": "California", 
                "Riverside": "California", "Corpus Christi": "Texas", "Lexington": "Kentucky", 
                "Stockton": "California", "Henderson": "Nevada", "Saint Paul": "Minnesota", 
                "St. Louis": "Missouri", "Cincinnati": "Ohio", "Pittsburgh": "Pennsylvania", 
                "Greensboro": "North Carolina", "Anchorage": "Alaska", "Plano": "Texas", 
                "Lincoln": "Nebraska", "Orlando": "Florida", "Irvine": "California", 
                "Newark": "New Jersey", "Toledo": "Ohio", "Durham": "North Carolina", 
                "Chula Vista": "California", "Fort Wayne": "Indiana", "Jersey City": "New Jersey", 
                "St. Petersburg": "Florida", "Laredo": "Texas", "Madison": "Wisconsin", 
                "Chandler": "Arizona", "Buffalo": "New York", "Lubbock": "Texas", 
                "Scottsdale": "Arizona", "Reno": "Nevada", "Glendale": "Arizona", 
                "Gilbert": "Arizona", "Winston-Salem": "North Carolina", "North Las Vegas": "Nevada", 
                "Norfolk": "Virginia", "Chesapeake": "Virginia", "Garland": "Texas", 
                "Irving": "Texas", "Hialeah": "Florida", "Fremont": "California", 
                "Boise": "Idaho", "Richmond": "Virginia", "Baton Rouge": "Louisiana", 
                "Spokane": "Washington", "Des Moines": "Iowa", "Tacoma": "Washington", 
                "San Bernardino": "California", "Modesto": "California", "Fontana": "California", 
                "Santa Clarita": "California", "Birmingham": "Alabama", "Oxnard": "California", 
                "Fayetteville": "North Carolina", "Moreno Valley": "California", "Rochester": "New York", 
                "Glendale": "California", "Huntington Beach": "California", "Salt Lake City": "Utah", 
                "Grand Rapids": "Michigan", "Amarillo": "Texas", "Yonkers": "New York", 
                "Aurora": "Illinois", "Montgomery": "Alabama",
                "Savannah": "Georgia", "Charleston": "South Carolina", "Knoxville": "Tennessee",
                "Providence": "Rhode Island", "Fort Lauderdale": "Florida", "Newport Beach": "California",
                "Santa Monica": "California", "Asheville": "North Carolina", "Boulder": "Colorado",
                "Ann Arbor": "Michigan", "Naples": "Florida", "Santa Fe": "New Mexico",
                "Key West": "Florida", "Sedona": "Arizona", "Aspen": "Colorado",
                "Napa": "California", "Palm Springs": "California", "Malibu": "California",
                "Monterey": "California", "Sarasota": "Florida", "Daytona Beach": "Florida",
                "Atlantic City": "New Jersey", "Park City": "Utah", "Myrtle Beach": "South Carolina",
                "Hilton Head": "South Carolina", "Cape Cod": "Massachusetts", "Laguna Beach": "California",
                "Carmel-by-the-Sea": "California", "Telluride": "Colorado", "Vail": "Colorado",
                "Maui": "Hawaii", "Kauai": "Hawaii", "Big Island": "Hawaii",
                "Juneau": "Alaska", "Fairbanks": "Alaska", "Sitka": "Alaska",
                "Ketchikan": "Alaska", "Kodiak": "Alaska", "Anchorage": "Alaska",
                "Olympia": "Washington", "Salem": "Oregon", "Bozeman": "Montana",
                "Missoula": "Montana", "Jackson": "Wyoming", "Cheyenne": "Wyoming",
                "Sioux Falls": "South Dakota", "Fargo": "North Dakota", "Bismarck": "North Dakota",
                "Burlington": "Vermont", "Portland": "Maine", "Manchester": "New Hampshire",
                "Hartford": "Connecticut", "Wilmington": "Delaware", "Annapolis": "Maryland",
                "Richmond": "Virginia", "Charleston": "West Virginia", "Frankfort": "Kentucky",
                "Nashville": "Tennessee", "Little Rock": "Arkansas", "Jackson": "Mississippi",
                "Baton Rouge": "Louisiana", "Austin": "Texas", "Santa Fe": "New Mexico",
                "Phoenix": "Arizona", "Carson City": "Nevada", "Salt Lake City": "Utah",
                "Boise": "Idaho", "Helena": "Montana", "Cheyenne": "Wyoming",
                "Denver": "Colorado", "Lincoln": "Nebraska", "Topeka": "Kansas",
                "Oklahoma City": "Oklahoma", "Des Moines": "Iowa", "St. Paul": "Minnesota",
                "Madison": "Wisconsin", "Lansing": "Michigan", "Indianapolis": "Indiana",
                "Columbus": "Ohio", "Harrisburg": "Pennsylvania", "Trenton": "New Jersey",
                "Albany": "New York", "Hartford": "Connecticut", "Providence": "Rhode Island",
                "Boston": "Massachusetts", "Concord": "New Hampshire", "Montpelier": "Vermont",
                "Augusta": "Maine"
            },
            "Canada": {
                "Toronto": "Ontario", "Montreal": "Quebec", "Vancouver": "British Columbia", 
                "Calgary": "Alberta", "Edmonton": "Alberta", "Ottawa": "Ontario", 
                "Winnipeg": "Manitoba", "Quebec City": "Quebec", "Hamilton": "Ontario", 
                "Kitchener": "Ontario", "London": "Ontario", "Victoria": "British Columbia", 
                "Halifax": "Nova Scotia", "Oshawa": "Ontario", "Windsor": "Ontario", 
                "Saskatoon": "Saskatchewan", "Regina": "Saskatchewan", "St. Catharines": "Ontario", 
                "Kelowna": "British Columbia", "Barrie": "Ontario", "Sherbrooke": "Quebec", 
                "Guelph": "Ontario", "Kanata": "Ontario", "Abbotsford": "British Columbia", 
                "Trois-Rivières": "Quebec", "Kingston": "Ontario", "Milton": "Ontario", 
                "Thunder Bay": "Ontario", "St. John's": "Newfoundland and Labrador", 
                "Moncton": "New Brunswick", "Nanaimo": "British Columbia", "Sudbury": "Ontario", 
                "Brantford": "Ontario", "Red Deer": "Alberta", "Lethbridge": "Alberta", 
                "Kamloops": "British Columbia", "Prince George": "British Columbia", 
                "Medicine Hat": "Alberta", "Drummondville": "Quebec", "Saint John": "New Brunswick", 
                "Peterborough": "Ontario", "Chilliwack": "British Columbia", "Chatham": "Ontario", 
                "Waterloo": "Ontario", "Cape Breton": "Nova Scotia", "Sarnia": "Ontario", 
                "Fort McMurray": "Alberta", "Fredericton": "New Brunswick", 
                "Grande Prairie": "Alberta", "North Bay": "Ontario"
            },
            "United Kingdom": {
                "London": "England", "Birmingham": "England", "Manchester": "England", 
                "Glasgow": "Scotland", "Liverpool": "England", "Leeds": "England", 
                "Sheffield": "England", "Edinburgh": "Scotland", "Bristol": "England", 
                "Belfast": "Northern Ireland", "Newcastle": "England", "Cardiff": "Wales", 
                "Leicester": "England", "Nottingham": "England", "Coventry": "England", 
                "Bradford": "England", "Stoke-on-Trent": "England", "Wolverhampton": "England", 
                "Plymouth": "England", "Southampton": "England", "Reading": "England", 
                "Derby": "England", "Northampton": "England", "Aberdeen": "Scotland", 
                "Portsmouth": "England", "Luton": "England", "Preston": "England", 
                "Milton Keynes": "England", "Sunderland": "England", "Norwich": "England", 
                "Walsall": "England", "Bournemouth": "England", "Southend-on-Sea": "England", 
                "Swindon": "England", "Dundee": "Scotland", "Huddersfield": "England", 
                "Oxford": "England", "Middlesbrough": "England", "Blackpool": "England", 
                "Bolton": "England", "Ipswich": "England", "Telford": "England", 
                "York": "England", "Peterborough": "England", "Cambridge": "England", 
                "Gloucester": "England", "Watford": "England", "Rotherham": "England", 
                "Newport": "Wales", "Exeter": "England"
            },
            "Australia": {
                "Sydney": "New South Wales", "Melbourne": "Victoria", "Brisbane": "Queensland", 
                "Perth": "Western Australia", "Adelaide": "South Australia", "Gold Coast": "Queensland", 
                "Newcastle": "New South Wales", "Canberra": "Australian Capital Territory", 
                "Sunshine Coast": "Queensland", "Wollongong": "New South Wales", 
                "Geelong": "Victoria", "Hobart": "Tasmania", "Townsville": "Queensland", 
                "Cairns": "Queensland", "Darwin": "Northern Territory", "Toowoomba": "Queensland", 
                "Ballarat": "Victoria", "Bendigo": "Victoria", "Albury": "New South Wales", 
                "Launceston": "Tasmania", "Mackay": "Queensland", "Rockhampton": "Queensland", 
                "Bunbury": "Western Australia", "Bundaberg": "Queensland", 
                "Coffs Harbour": "New South Wales", "Wagga Wagga": "New South Wales", 
                "Hervey Bay": "Queensland", "Mildura": "Victoria", "Shepparton": "Victoria", 
                "Port Macquarie": "New South Wales", "Gladstone": "Queensland", 
                "Tamworth": "New South Wales", "Traralgon": "Victoria", "Orange": "New South Wales", 
                "Geraldton": "Western Australia", "Bowral": "New South Wales", 
                "Dubbo": "New South Wales", "Nowra": "New South Wales", "Bathurst": "New South Wales", 
                "Warrnambool": "Victoria", "Kalgoorlie": "Western Australia", 
                "Busselton": "Western Australia", "Albany": "Western Australia", 
                "Warragul": "Victoria", "Devonport": "Tasmania"
            }
        };

        // Selected cities storage - now stores city with state
        let selectedCities = new Map(); // Key: "City, State", Value: {city, state, country}

        // ========================================
        // UPDATED NICHES WITH EXPANDED VARIATIONS
        // ========================================
        const nanoBananaNiches = {
            soapShops: {
                name: 'Soap Shops',
                variations: [
                    'soap shop',
                    'soap business',
                    'handmade soap',
                    'natural soap brand',
                    'organic soap company',
                    'soap store',
                    'artisanal soap',
                    'body soap brand',
                    'skin care soap'
                ]
            },
            candleShops: {
                name: 'Candle Shops',
                variations: [
                    'candle shop',
                    'candle business',
                    'handmade candles',
                    'scented candles',
                    'soy candles',
                    'candle brand',
                    'home fragrance candles',
                    'candle store',
                    'luxury candles'
                ]
            },
            bakeries: {
                name: 'Bakeries',
                variations: [
                    'bakery',
                    'cake shop',
                    'cupcake shop',
                    'pastry shop',
                    'bakehouse',
                    'dessert shop',
                    'bread bakery',
                    'wedding cakes',
                    'custom cakes'
                ]
            },
            cakeDecorators: {
                name: 'Cake Decorators',
                variations: [
                    'cake decorator',
                    'cake decorators',
                    'custom cakes',
                    'birthday cakes',
                    'wedding cakes',
                    'cake artist',
                    'cake studio',
                    'cake shop',
                    'cake designer',
                    'luxury cakes',
                    'dessert studio',
                    'cupcake shop'
                ]
            },
            iceCreamShops: {
                 name: 'Ice Cream Shops',
                 variations: [
                     'ice cream shop',
                     'ice cream parlour',
                     'ice cream parlor',
                     'gelato shop',
                     'frozen yogurt',
                     'dessert shop',
                     'milkshake bar',
                     'soft serve',
                     'artisanal ice cream',
                     'creamery',
                     'popsicle shop'
                 ]
             },
             artisanChocolateMakers: {
                 name: 'Artisan Chocolate Makers',
                 variations: [
                     'chocolate maker',
                     'handmade chocolates',
                     'craft chocolate',
                     'chocolate studio',
                     'chocolate artisan'
                 ]
             },
             macaronShops: {
                 name: 'Macaron Shops',
                 variations: [
                     'macaron shop',
                     'french macarons',
                     'macaron bakery',
                     'macaron boutique',
                     'macaron studio'
                 ]
             },
             gourmetCheeseShops: {
                 name: 'Gourmet Cheese Shops',
                 variations: [
                     'cheese shop',
                     'artisan cheese',
                     'gourmet cheese',
                     'cheese boutique',
                     'cheese studio'
                 ]
             },
             kombuchaBreweries: {
                 name: 'Kombucha Breweries',
                 variations: [
                     'Kombucha Brewery',
                     'Kombucha Brewer',
                     'Kombucha Brand',
                     'Handcrafted Kombucha',
                     'Local Kombucha',
                     'Organic Kombucha',
                     'Small Batch Kombucha'
                 ]
             },
             craftCoffeeRoasters: {
                 name: 'Craft Coffee Roasters',
                 variations: [
                     'Coffee Roaster',
                     'Craft Coffee',
                     'Artisan Coffee Roaster',
                     'Specialty Coffee Roaster',
                     'Micro Coffee Roastery',
                     'Hand Roasted Coffee',
                     'Small Batch Coffee Roaster',
                     'Local Coffee Brand'
                 ]
             },
             juiceBarsSmoothieBoutiques: {
                name: 'Juice Bars and Smoothie Boutiques',
                variations: [
                    'Juice Bar',
                    'Smoothie Shop',
                    'Cold Pressed Juice',
                    'Organic Juice Bar',
                    'Smoothie Bar',
                    'Healthy Juice Bar',
                    'Acai Bowl Bar',
                    'Fresh Juice Company'
                ]
            },
            handmadeJewelryDesigners: {
                name: 'Handmade Jewelry Designers',
                variations: [
                    'Handmade Jewelry Designer',
                    'Custom Jewelry Maker',
                    'Artisan Jewelry',
                    'Jewelry Artist',
                    'Handcrafted Jewelry',
                    'Boutique Jewelry Brand',
                    'Handmade Necklace',
                    'Boho Jewelry Shop',
                    'Minimalist Jewelry Designer',
                    'Unique Jewelry Creator'
                ]
            },
            potteryCeramicsStudios: {
                name: 'Pottery & Ceramics Studios',
                variations: [
                    'Pottery Studio',
                    'Ceramics Studio',
                    'Handmade Pottery',
                    'Ceramic Artist',
                    'Artisan Ceramics',
                    'Clay Workshop',
                    'Wheel Throwing Studio',
                    'Pottery Maker',
                    'Handcrafted Ceramics',
                    'Pottery Designer'
                ]
            },
            smallBatchTextileEmbroideryShops: {
                name: 'Small Batch Textile or Embroidery Shops',
                variations: [
                    'Textile Artist',
                    'Handmade Textile Shop',
                    'Small Batch Embroidery',
                    'Embroidery Studio',
                    'Custom Embroidery Business',
                    'Textile Designer',
                    'Handwoven Fabric Brand',
                    'Embroidery Artist',
                    'Artisan Textile Workshop',
                    'Handcrafted Fabric Studio'
                ]
            },
            plantNurseriesIndoorPlantBoutiques: {
                name: 'Plant Nurseries & Indoor Plant Boutiques',
                variations: [
                    'Plant Nursery',
                    'Indoor Plant Boutique',
                    'Houseplant Shop',
                    'Plant Store',
                    'Tropical Plant Boutique',
                    'Succulent Shop',
                    'Plant Design Studio',
                    'Urban Jungle Shop',
                    'Rare Plant Seller',
                    'Greenhouse Boutique'
                ]
            },
            boutiqueStationeryShops: {
                name: 'Boutique Stationery Shops',
                variations: [
                    'Boutique Stationery Shop',
                    'Custom Stationery Designer',
                    'Luxury Stationery Brand',
                    'Paper Goods Store',
                    'Wedding Invitation Designer',
                    'Handmade Cards Shop',
                    'Calligraphy Studio',
                    'Stationery Brand',
                    'Artisan Notebook Maker',
                    'Personalized Stationery Business'
                ]
            },
            luxuryPicnicEventRentalCompanies: {
                 name: 'Luxury Picnic or Event Rental Companies',
                 variations: [
                     'Luxury Picnic Company',
                     'Event Rental Business',
                     'Luxury Picnic Setup',
                     'Picnic Experience Company',
                     'Boho Picnic Service',
                     'Luxury Event Styling',
                     'Event Decor Rental',
                     'Outdoor Event Setup',
                     'Luxury Event Planner',
                     'Styled Picnic Business'
                 ]
             },
             smallPhotographyStudios: {
                 name: 'Small Photography Studios',
                 variations: [
                     'Photography Studio',
                     'Portrait Studio',
                     'Lifestyle Photographer',
                     'Creative Photography Studio',
                     'Small Photography Business',
                     'Brand Photographer',
                     'Product Photography Studio',
                     'Creative Portrait Photographer',
                     'Local Photography Studio',
                     'Photography Boutique'
                 ]
             },
             personalBrandingStylistsMakeupArtists: {
                 name: 'Personal Branding Stylists or Makeup Artists',
                 variations: [
                     'Personal Branding Stylist',
                     'Brand Stylist',
                     'Makeup Artist',
                     'Beauty Stylist',
                     'Creative Branding Stylist',
                     'Personal Brand Consultant',
                     'Makeup Studio',
                     'Freelance Makeup Artist',
                     'Editorial Stylist',
                     'Photoshoot Stylist'
                 ]
             },
             independentCuratedBookshops: {
                 name: 'Independent Bookshops with Curated Collections',
                 variations: [
                     'Independent Bookstore',
                     'Curated Bookshop',
                     'Indie Bookstore',
                     'Local Bookshop',
                     'Book Boutique',
                     'Art Bookstore',
                     'Rare Books Shop',
                     'Small Independent Bookshop',
                     'Book Lounge',
                     'Vintage Bookstore'
                 ]
             },
             tinyLuxuryHotelsAirbnbs: {
                 name: 'Tiny Luxury Hotels or Airbnbs',
                 variations: [
                     'Luxury Airbnb',
                     'Tiny Luxury Hotel',
                     'Boutique Airbnb',
                     'Small Boutique Hotel',
                     'Luxury Guesthouse',
                     'Designer Airbnb',
                     'Modern Airbnb Stay',
                     'Chic Boutique Stay',
                     'Luxury Cabin Airbnb',
                     'Aesthetic Airbnb Rental'
                 ]
             },
             weddingFlorists: {
                 name: 'Wedding Florists',
                 variations: [
                     'Wedding florist',
                     'Bridal flower shop',
                     'Luxury wedding flowers',
                     'Event floral designer',
                     'Wedding bouquet designer',
                     'Bridal floral studio',
                     'Wedding floral arrangements',
                     'Boutique florist',
                     'Luxury florist',
                     'Wedding flower stylist'
                 ]
             },
             customPartyEventDesigners: {
                 name: 'Custom Party or Event Designers',
                 variations: [
                     'Custom event designer',
                     'Luxury event planner',
                     'Party stylist',
                     'Event decor company',
                     'Boutique event designer',
                     'Luxury party planner',
                     'Balloon and decor stylist',
                     'Wedding and party designer',
                     'Themed event designer',
                     'Luxury celebration planner'
                 ]
             },
             popupHolidayMarkets: {
                 name: 'Pop-up Holiday Markets',
                 variations: [
                     'Pop-up holiday market',
                     'Christmas pop-up shop',
                     'Seasonal market vendor',
                     'Holiday artisan market',
                     'Festive craft fair',
                     'Local holiday pop-up',
                     'Winter market stall',
                     'Holiday vendor market',
                     'Pop-up festive event',
                     'Seasonal gift market'
                 ]
             }
         };

         const niches = {
            barberShops: {
                name: 'Barber Shops',
                variations: [
                    'Barber Shop', 'Barbershop', 'Barber', 'Barber Studio', 'Barber Lounge',
                    'Men\'s Grooming', 'Fade', 'Barber & Co', 'Barbers', 'Barber Salon',
                    'Barber Parlor', 'Men\'s Barbershop', 'Gentlemen\'s Barber', 'Classic Barber',
                    'Modern Barber', 'Traditional Barber', 'Premium Barber', 'Elite Barber',
                    'Master Barber', 'Professional Barber', 'Local Barber', 'Neighborhood Barber',
                    'Urban Barber', 'Vintage Barber', 'Old School Barber'
                ]
            },
            nailSalons: {
                name: 'Nail Salons',
                variations: [
                    'Nail Salon', 'Nails', 'Nail Tech', 'Nail Artist', 'Nail Studio',
                    'Nail Bar', 'Nail Spa', 'Nail Lounge', 'Manicure', 'Pedicure',
                    'Mani Pedi', 'Nail Design', 'Nail Art', 'Gel Nails', 'Acrylic Nails',
                    'Dip Nails', 'Nail Technician', 'Nail Boutique', 'Nail Shop',
                    'Nail Care', 'Nail Polish', 'Nail Expert', 'Nail Pro', 'Nailery'
                ]
            },
            tattooShops: {
                name: 'Tattoo Shops',
                variations: [
                    'Tattoo Shop', 'Tattoo Studio', 'Tattoo Parlor', 'Tattoo Artist',
                    'Ink Shop', 'Tattoo Lounge', 'Tattoo', 'Tattoos', 'Ink Studio',
                    'Tattoo Co', 'Ink Artist', 'Tattoo Gallery', 'Tattoo Art', 'Body Art',
                    'Ink Parlor', 'Tattoo Boutique', 'Tattoo Pro', 'Ink Master',
                    'Tattoo Design', 'Custom Tattoo', 'Tattoo Collective', 'Ink Lab',
                    'Tattoo House', 'Tattoo Bar', 'Ink Lounge'
                ]
            },
            piercingStudios: {
                name: 'Piercing Studios',
                variations: [
                    'Piercing Studio', 'Piercing', 'Piercings', 'Piercer', 'Body Piercing',
                    'Ear Piercing', 'Piercing Shop', 'Piercing Parlor', 'Pierce',
                    'Body Jewelry', 'Piercing Artist', 'Piercing Lounge', 'Piercing Boutique',
                    'Body Modification', 'Body Mod', 'Piercing Pro', 'Piercing Specialist',
                    'Professional Piercing', 'Piercing Service', 'Piercing Bar'
                ]
            },
            massageTherapy: {
                name: 'Massage Therapy',
                variations: [
                    'Massage', 'Massage Therapy', 'Massage Therapist', 'Spa Massage',
                    'Therapeutic Massage', 'Deep Tissue', 'Swedish Massage', 'Massage Studio',
                    'Massage Clinic', 'Bodywork', 'Massage Spa', 'Relaxation Massage',
                    'Sports Massage', 'Massage Wellness', 'Massage Center', 'Massage Parlor',
                    'Healing Hands', 'Massage Pro', 'Body Therapy', 'Muscle Therapy',
                    'Massage Lounge', 'Tension Relief'
                ]
            },
            spas: {
                name: 'Spas',
                variations: [
                    'Spa', 'Day Spa', 'Wellness Spa', 'Beauty Spa', 'Spa Center',
                    'Spa Lounge', 'Spa Studio', 'Spa Boutique', 'Spa Wellness',
                    'Spa Therapy', 'Spa Treatment', 'Relaxation Spa', 'Luxury Spa',
                    'Spa Retreat', 'Medical Spa', 'Med Spa', 'Spa Services',
                    'Spa Resort', 'Spa Sanctuary', 'Spa Oasis', 'Spa Experience',
                    'Pamper Spa', 'Spa Life'
                ]
            },
            tanningSalons: {
                name: 'Tanning Salons',
                variations: [
                    'Tanning Salon', 'Tanning', 'Tan', 'Tanning Studio', 'Tanning Center',
                    'Spray Tan', 'Tanning Lounge', 'Tanning Spa', 'Sun Tan', 'Bronze',
                    'Bronzing Studio', 'Tanning Boutique', 'Tanning Bed', 'Sunless Tanning',
                    'Tanning Pro', 'Tanning Bar', 'Glow Studio', 'Tan Line',
                    'UV Tanning', 'Tanning Place', 'Tan Shop'
                ]
            },
            hairSalons: {
                name: 'Hair Salons',
                variations: [
                    'Hair Salon', 'Salon', 'Hair Studio', 'Hair Stylist', 'Hairdresser',
                    'Hair Shop', 'Hair Lounge', 'Hair Bar', 'Hair Boutique', 'Hair Care',
                    'Hair Design', 'Hair Artist', 'Hair Spa', 'Hair Center', 'Beauty Salon',
                    'Hair Pro', 'Hair Expert', 'Hair Specialist', 'Styling Studio',
                    'Hair Lab', 'Hair House', 'Hair Co', 'Hair Room', 'Hair Works'
                ]
            },
            plumbers: {
                name: 'Plumbers',
                variations: [
                    'Plumber', 'Plumbing', 'Plumbing Service', 'Plumbing Repair',
                    'Plumbing Contractor', 'Plumbing Pro', 'Plumbing Expert', 'Plumbing Company',
                    'Drain Service', 'Pipe Repair', 'Water Heater', 'Plumbing Solutions',
                    'Emergency Plumber', 'Plumbing Works', 'Master Plumber',
                    'Plumbing Maintenance', 'Leak Repair', 'Sewer Service',
                    'Plumbing Install', 'Pipeworks'
                ]
            },
            electricians: {
                name: 'Electricians',
                variations: [
                    'Electrician', 'Electrical', 'Electric Service', 'Electrical Contractor',
                    'Electrical Repair', 'Electric Company', 'Electrical Pro', 'Electrical Expert',
                    'Electrical Work', 'Wiring Service', 'Electrical Install', 'Power Service',
                    'Master Electrician', 'Electrical Solutions', 'Electrical Maintenance',
                    'Electric Repair', 'Spark', 'Electrical Shop', 'Voltage', 'Electric Pro'
                ]
            },
            hvacContractors: {
                name: 'HVAC Contractors',
                variations: [
                    'HVAC', 'Heating Cooling', 'AC Repair', 'Air Conditioning',
                    'Heating Service', 'Cooling Service', 'HVAC Service', 'HVAC Contractor',
                    'HVAC Pro', 'HVAC Expert', 'HVAC Repair', 'HVAC Install',
                    'Climate Control', 'HVAC Solutions', 'Furnace Repair', 'AC Service',
                    'Heating Repair', 'Cooling Repair', 'HVAC Company', 'Air Service',
                    'Temperature Control'
                ]
            },
            roofers: {
                name: 'Roofers',
                variations: [
                    'Roofer', 'Roofing', 'Roofing Contractor', 'Roofing Company',
                    'Roof Repair', 'Roofing Service', 'Roofing Pro', 'Roofing Expert',
                    'Roof Replacement', 'Roofing Solutions', 'Roof Install', 'Roofing Work',
                    'Roof Maintenance', 'Roof Service', 'Shingle Repair', 'Roof Leak',
                    'Roofing Crew', 'Roof Restoration', 'Roofing Systems', 'Roof Pro',
                    'Rooftop Service'
                ]
            },
            painters: {
                name: 'Painters',
                variations: [
                    'Painter', 'Painting', 'Painting Service', 'Painting Contractor',
                    'Paint Pro', 'Painting Company', 'House Painter', 'Painting Expert',
                    'Paint Service', 'Interior Painting', 'Exterior Painting',
                    'Painting Crew', 'Paint Work', 'Painting Solutions', 'Paint Contractor',
                    'Wall Painting', 'Paint Tech', 'Paint Shop', 'Color Specialist',
                    'Painting Studio'
                ]
            },
            landscapers: {
                name: 'Landscapers',
                variations: [
                    'Landscaper', 'Landscaping', 'Landscape Design', 'Lawn Care',
                    'Lawn Service', 'Landscaping Service', 'Landscaping Company',
                    'Landscape Pro', 'Landscaping Contractor', 'Yard Work', 'Lawn Maintenance',
                    'Garden Service', 'Landscaping Solutions', 'Grounds Maintenance',
                    'Lawn Pro', 'Landscaping Crew', 'Landscape Maintenance', 'Yard Service',
                    'Outdoor Service', 'Green Care'
                ]
            },
            handymanServices: {
                name: 'Handyman Services',
                variations: [
                    'Handyman', 'Handyman Service', 'Handy', 'Fix It', 'Repair Service',
                    'Handyman Pro', 'Home Repair', 'Handyman Company', 'Maintenance Service',
                    'General Repair', 'Handyman Solutions', 'Home Maintenance',
                    'Handyman Work', 'Repair Pro', 'Fix All', 'Handyman Contractor',
                    'Home Service', 'Repair Specialist', 'Maintenance Pro', 'Home Fix'
                ]
            },
            cleaningServices: {
                name: 'Cleaning Services',
                variations: [
                    'Cleaning Service', 'Cleaning', 'Cleaners', 'Cleaning Company',
                    'House Cleaning', 'Maid Service', 'Cleaning Pro', 'Home Cleaning',
                    'Office Cleaning', 'Cleaning Crew', 'Cleaning Solutions',
                    'Janitorial Service', 'Clean Team', 'Deep Cleaning',
                    'Cleaning Maintenance', 'Clean Pro', 'Cleaning Lady', 'Spotless',
                    'Cleaning Works'
                ]
            },
            autoRepair: {
                name: 'Auto Repair',
                variations: [
                    'Auto Repair', 'Car Repair', 'Mechanic', 'Auto Mechanic', 'Auto Service',
                    'Car Service', 'Auto Shop', 'Repair Shop', 'Garage', 'Auto Fix',
                    'Car Mechanic', 'Auto Pro', 'Car Fix', 'Auto Expert', 'Automotive Repair',
                    'Car Doctor', 'Auto Tech', 'Auto Garage', 'Car Clinic',
                    'Auto Maintenance', 'Auto Solutions', 'Car Specialist', 'Auto Works'
                ]
            },
            carWash: {
                name: 'Car Wash',
                variations: [
                    'Car Wash', 'Auto Wash', 'Car Washing', 'Car Detailing', 'Wash Service',
                    'Car Clean', 'Auto Clean', 'Car Wash Pro', 'Wash Center', 'Car Spa',
                    'Auto Spa', 'Wash Pro', 'Car Wash Service', 'Wash Station', 'Clean Car',
                    'Wash Expert', 'Car Wash Center', 'Auto Wash Pro', 'Wash N Go',
                    'Wash Works', 'Car Shine', 'Wash Bay', 'Wash Shop'
                ]
            },
            tireShops: {
                name: 'Tire Shops',
                variations: [
                    'Tire Shop', 'Tires', 'Tire Service', 'Tire Center', 'Tire Pro',
                    'Tire Store', 'Tire Repair', 'Tire Specialist', 'Tire Sales',
                    'Tire Replacement', 'Tire Rotation', 'Tire Company', 'Tire Dealer',
                    'Wheel Service', 'Tire Tech', 'Tire Solutions', 'Tire Maintenance',
                    'Tire Fix', 'Tire Works', 'Tire Outlet', 'Tire Warehouse',
                    'Tire Mart', 'Tire Express'
                ]
            },
            autoDetailing: {
                name: 'Auto Detailing',
                variations: [
                    'Auto Detailing', 'Car Detailing', 'Detailing', 'Detail Shop',
                    'Detail Service', 'Auto Detail', 'Car Detail', 'Detailing Pro',
                    'Mobile Detailing', 'Detail Center', 'Detailing Studio', 'Detail Pro',
                    'Car Spa', 'Detailing Solutions', 'Detail Works', 'Detailing Company',
                    'Car Care', 'Detailing Service', 'Auto Spa', 'Detail Garage'
                ]
            },
            oilChange: {
                name: 'Oil Change',
                variations: [
                    'Oil Change', 'Quick Lube', 'Lube Center', 'Oil Service', 'Lube Shop',
                    'Oil Change Pro', 'Quick Oil', 'Lube Pro', 'Oil Change Service',
                    'Lube Service', 'Oil Change Center', 'Lube Express', 'Oil Change Station',
                    'Quick Service', 'Oil Expert', 'Lube Specialist', 'Fast Lube',
                    'Oil Tech', 'Lube Tech', 'Oil Maintenance', 'Oil Works', 'Lube Station'
                ]
            },
            brakeRepair: {
                name: 'Brake Repair',
                variations: [
                    'Brake Repair', 'Brake Service', 'Brakes', 'Brake Shop',
                    'Brake Specialist', 'Brake Pro', 'Brake Expert', 'Brake Center',
                    'Brake Tech', 'Brake Replacement', 'Brake Maintenance', 'Brake Fix',
                    'Brake Solutions', 'Brake Work', 'Brake Company', 'Brake Clinic',
                    'Brake Station', 'Brake Express', 'Brake Masters', 'Brake Doctor',
                    'Brake Garage', 'Brake Systems'
                ]
            },
            transmissionRepair: {
                name: 'Transmission Repair',
                variations: [
                    'Transmission Repair', 'Transmission', 'Transmission Service',
                    'Trans Repair', 'Transmission Shop', 'Trans Service',
                    'Transmission Specialist', 'Transmission Pro', 'Trans Shop',
                    'Transmission Center', 'Trans Specialist', 'Transmission Tech',
                    'Trans Pro', 'Transmission Fix', 'Transmission Work', 'Trans Expert',
                    'Transmission Solutions', 'Transmission Clinic', 'Trans Tech',
                    'Transmission Rebuild', 'Trans Center'
                ]
            },
            autoBodyShops: {
                name: 'Auto Body Shops',
                variations: [
                    'Auto Body', 'Body Shop', 'Collision Repair', 'Auto Body Repair',
                    'Collision Center', 'Body Work', 'Auto Body Shop', 'Collision Service',
                    'Body Repair', 'Paint Body', 'Collision Pro', 'Body Shop Pro',
                    'Auto Body Expert', 'Collision Specialist', 'Body Specialist',
                    'Auto Body Center', 'Collision Expert', 'Body Pro', 'Auto Body Service',
                    'Collision Clinic', 'Body Works', 'Collision Tech'
                ]
            },
            interiorDesigners: {
                name: 'Interior Designers',
                variations: [
                    'Interior Design', 'Interior Designer', 'Home Design', 'Design Studio',
                    'Interior', 'Home Decor', 'Interior Styling', 'Design Service',
                    'Interior Decorator', 'Design Pro', 'Interior Expert', 'Design Specialist',
                    'Home Styling', 'Interior Solutions', 'Design Consultant',
                    'Interior Studio', 'Decor Design', 'Design House', 'Interior Pro',
                    'Design Expert', 'Interior Service', 'Design Company', 'Interior Works'
                ]
            },
            photographers: {
                name: 'Photographers',
                variations: [
                    'Photographer', 'Photography', 'Photo Studio', 'Photo', 'Photos',
                    'Photography Service', 'Photo Pro', 'Photography Studio',
                    'Photographer Pro', 'Photo Shoot', 'Photography Expert',
                    'Photo Specialist', 'Photography Company', 'Photo Service',
                    'Photography Business', 'Portrait Studio', 'Photo Works',
                    'Photography Solutions', 'Photo Artist', 'Photography Pro',
                    'Photo House', 'Photo Lab'
                ]
            },
            personalTrainers: {
                name: 'Personal Trainers',
                variations: [
                    'Personal Trainer', 'Trainer', 'Fitness Trainer', 'Personal Training',
                    'PT', 'Fitness Coach', 'Training', 'Personal Fitness', 'Fitness Pro',
                    'Trainer Pro', 'Fitness Expert', 'Training Service', 'Fitness Specialist',
                    'Personal Coach', 'Training Pro', 'Fitness Training', 'Workout Coach',
                    'Gym Trainer', 'Fitness Solutions', 'Training Expert',
                    'Fitness Instructor', 'Fitness Studio'
                ]
            },
            tutors: {
                name: 'Tutors',
                variations: [
                    'Tutor', 'Tutoring', 'Tutoring Service', 'Private Tutor', 'Tutor Pro',
                    'Tutoring Center', 'Academic Tutor', 'Tutoring Company', 'Tutor Expert',
                    'Tutoring Specialist', 'Education Tutor', 'Tutoring Solutions',
                    'Tutor Service', 'Learning Center', 'Tutoring Pro', 'Study Help',
                    'Tutor Specialist', 'Tutoring Studio', 'Academic Help', 'Tutor Center',
                    'Tutoring Expert', 'Education Service'
                ]
            },
            realEstateAgents: {
                name: 'Real Estate Agents',
                variations: [
                    'Real Estate', 'Realtor', 'Real Estate Agent', 'Realty',
                    'Property Agent', 'Real Estate Pro', 'Realtor Pro', 'Real Estate Expert',
                    'Property Specialist', 'Real Estate Service', 'Realty Pro',
                    'Real Estate Broker', 'Property Pro', 'Real Estate Specialist',
                    'Realty Expert', 'Real Estate Company', 'Property Expert',
                    'Real Estate Solutions', 'Realty Service', 'Real Estate Team',
                    'Property Service', 'Real Estate Group'
                ]
            },
            accountants: {
                name: 'Accountants',
                variations: [
                    'Accountant', 'Accounting', 'CPA', 'Tax Service', 'Accounting Service',
                    'Tax Pro', 'Accounting Firm', 'Accountant Pro', 'Tax Expert',
                    'Accounting Expert', 'Tax Specialist', 'Accounting Company', 'CPA Firm',
                    'Tax Prep', 'Accounting Specialist', 'Bookkeeping', 'Tax Accountant',
                    'Accounting Solutions', 'CPA Service', 'Tax Professional',
                    'Accounting Pro', 'Bookkeeper', 'Tax Advisor'
                ]
            },
            lawyers: {
                name: 'Lawyers',
                variations: [
                    'Lawyer', 'Attorney', 'Law Firm', 'Legal Service', 'Law Office',
                    'Attorney at Law', 'Legal Pro', 'Law Practice', 'Legal Expert',
                    'Lawyer Pro', 'Legal Specialist', 'Law Service', 'Attorney Pro',
                    'Legal Solutions', 'Law Company', 'Legal Counsel', 'Law Expert',
                    'Attorney Service', 'Legal Firm', 'Law Specialist', 'Legal Office',
                    'Law Group', 'Attorney Expert'
                ]
            },
            consultants: {
                name: 'Consultants',
                variations: [
                    'Consultant', 'Consulting', 'Consulting Service', 'Consulting Firm',
                    'Consultant Pro', 'Consulting Company', 'Business Consultant',
                    'Consulting Expert', 'Consultant Expert', 'Consulting Specialist',
                    'Consulting Solutions', 'Consultant Specialist', 'Consulting Pro',
                    'Advisory Service', 'Consultant Service', 'Consulting Group',
                    'Business Consulting', 'Consultant Firm', 'Consulting Office',
                    'Advisory', 'Consultant Company', 'Consulting Practice'
                ]
            },
            restaurants: {
                name: 'Restaurants',
                variations: [
                    'Restaurant', 'Resto', 'Eatery', 'Dining', 'Food Place',
                    'Restaurant Bar', 'Diner', 'Cafe Restaurant', 'Bistro', 'Grill',
                    'Kitchen', 'Food Spot', 'Eat Place', 'Restaurant Lounge',
                    'Food Restaurant', 'Dining Room', 'Restaurant Cafe', 'Food House',
                    'Restaurant Kitchen', 'Table Service', 'Restaurant Dining',
                    'Food Service', 'Restaurant Grill'
                ]
            },
            foodTrucks: {
                name: 'Food Trucks',
                variations: [
                    'Food Truck', 'Food Trailer', 'Mobile Food', 'Street Food',
                    'Food Van', 'Food Cart', 'Mobile Kitchen', 'Food Truck Co',
                    'Truck Food', 'Mobile Eats', 'Food Wagon', 'Street Eats',
                    'Food Truck Service', 'Mobile Dining', 'Food on Wheels',
                    'Truck Eats', 'Mobile Restaurant', 'Food Truck Kitchen',
                    'Street Kitchen', 'Food Mobile', 'Truck Kitchen',
                    'Food Truck Catering', 'Mobile Truck'
                ]
            },
            catering: {
                name: 'Catering',
                variations: [
                    'Catering', 'Catering Service', 'Caterer', 'Catering Company',
                    'Event Catering', 'Catering Pro', 'Food Catering',
                    'Catering Specialist', 'Catering Expert', 'Party Catering',
                    'Catering Solutions', 'Catering Business', 'Catering Kitchen',
                    'Catering Events', 'Catering Team', 'Corporate Catering',
                    'Catering Menu', 'Catering Chef', 'Catering Co', 'Catering Group',
                    'Event Caterer', 'Catering Food'
                ]
            },
            bakeries: {
                name: 'Bakeries',
                variations: [
                    'Bakery', 'Bakehouse', 'Bake Shop', 'Baker', 'Baking',
                    'Pastry Shop', 'Bread Shop', 'Cake Shop', 'Bakery Cafe',
                    'Artisan Bakery', 'Bake', 'Bakery Shop', 'Pastry', 'Bread Bakery',
                    'Cake Bakery', 'Bakery Kitchen', 'Baking Company', 'Sweet Bakery',
                    'Bakery Co', 'Fresh Bakery', 'Bakery Studio', 'Bake House',
                    'Bakery Boutique', 'Baking Studio'
                ]
            },
            coffeeShops: {
                name: 'Coffee Shops',
                variations: [
                    'Coffee Shop', 'Coffee', 'Cafe', 'Coffee House', 'Coffee Bar',
                    'Espresso Bar', 'Coffee Co', 'Coffee Lounge', 'Coffee Roasters',
                    'Coffee Cafe', 'Coffee Place', 'Coffee Studio', 'Coffee Company',
                    'Coffee Spot', 'Coffee Room', 'Coffee Kitchen', 'Coffee Boutique',
                    'Brew Coffee', 'Coffee Lab', 'Coffee Culture', 'Coffee Works',
                    'Coffee Station', 'Coffee Corner'
                ]
            },
            pizzaPlaces: {
                name: 'Pizza Places',
                variations: [
                    'Pizza', 'Pizzeria', 'Pizza Shop', 'Pizza Place', 'Pizza Restaurant',
                    'Pizza House', 'Pizza Kitchen', 'Pizza Co', 'Pizza Parlor',
                    'Pizza Joint', 'Pizza Pie', 'Pizza Bar', 'Pizza Cafe',
                    'Pizza Company', 'Pizza Spot', 'Pizza Oven', 'Pizza Delivery',
                    'Pizza Express', 'Pizza Studio', 'Pizza Works', 'Pizza Corner',
                    'Pizza Station', 'Pizza Factory'
                ]
            },
            foodDelivery: {
                name: 'Food Delivery',
                variations: [
                    'Food Delivery', 'Delivery', 'Food Delivery Service', 'Delivery Service',
                    'Food Courier', 'Delivery Kitchen', 'Food Delivery Co',
                    'Delivery Eats', 'Food Delivery App', 'Delivery Food',
                    'Food Delivery Company', 'Meal Delivery', 'Delivery Pro',
                    'Food Delivery Pro', 'Delivery Specialist', 'Food Delivery Expert',
                    'Delivery Solutions', 'Food Delivery Platform', 'Delivery Express',
                    'Food Delivery Team', 'Delivery Driver'
                ]
            },
            mealPrep: {
                name: 'Meal Prep',
                variations: [
                    'Meal Prep', 'Meal Prep Service', 'Meal Prep Co', 'Meal Prep Company',
                    'Meal Preparation', 'Prep Kitchen', 'Meal Prep Delivery',
                    'Healthy Meal Prep', 'Meal Prep Pro', 'Meal Prep Specialist',
                    'Prep Meals', 'Meal Prep Solutions', 'Meal Prep Expert',
                    'Meal Prep Kitchen', 'Meal Prep Business', 'Meal Prep Studio',
                    'Prep Service', 'Meal Prep Team', 'Meal Prep Shop',
                    'Meal Prep Works', 'Meal Prep Center'
                ]
            },
            chiropractors: {
                name: 'Chiropractors',
                variations: [
                    'Chiropractor', 'Chiropractic', 'Chiro', 'Chiropractic Care',
                    'Chiropractic Clinic', 'Chiropractor Office', 'Chiro Clinic',
                    'Chiropractic Center', 'Chiropractic Service', 'Spine Care',
                    'Chiro Care', 'Chiropractic Doctor', 'Chiro Pro',
                    'Chiropractic Wellness', 'Chiropractic Health', 'Chiro Center',
                    'Chiropractic Specialist', 'Spine Doctor', 'Chiro Service',
                    'Chiropractic Pro', 'Chiro Expert', 'Chiropractic Treatment'
                ]
            },
            dentists: {
                name: 'Dentists',
                variations: [
                    'Dentist', 'Dental', 'Dental Care', 'Dental Clinic', 'Dental Office',
                    'Dentistry', 'Dental Center', 'Dental Practice', 'Dental Service',
                    'Teeth Care', 'Dental Pro', 'Dental Health', 'Dental Doctor',
                    'Smile Dental', 'Dental Specialist', 'Dental Expert',
                    'Dental Studio', 'Dental Wellness', 'Dental Group', 'Dental Team',
                    'Dental Solutions', 'Dental Work', 'Dental Lab'
                ]
            },
            physicalTherapy: {
                name: 'Physical Therapy',
                variations: [
                    'Physical Therapy', 'PT', 'Physical Therapist', 'Physio',
                    'Physiotherapy', 'Therapy Clinic', 'PT Clinic', 'Physical Therapy Center',
                    'Rehab', 'Rehabilitation', 'Therapy Service', 'PT Service',
                    'Physical Therapy Clinic', 'Therapy Pro', 'PT Pro', 'Therapy Center',
                    'Physical Therapy Pro', 'Rehab Center', 'Therapy Specialist',
                    'PT Specialist', 'Therapy Expert', 'Physical Therapy Office'
                ]
            },
            yogaStudios: {
                name: 'Yoga Studios',
                variations: [
                    'Yoga Studio', 'Yoga', 'Yoga Class', 'Yoga Center', 'Yoga Space',
                    'Yoga Practice', 'Yoga Room', 'Yoga House', 'Yoga Sanctuary',
                    'Yoga Wellness', 'Yoga Flow', 'Yoga Pro', 'Yoga Lounge',
                    'Yoga Life', 'Yoga Barn', 'Yoga Spot', 'Yoga Place',
                    'Yoga Company', 'Yoga Fitness', 'Yoga Boutique', 'Yoga Academy',
                    'Yoga School', 'Yoga Collective'
                ]
            },
            gyms: {
                name: 'Gyms',
                variations: [
                    'Gym', 'Fitness Center', 'Fitness', 'Fitness Gym', 'Gym Fitness',
                    'Workout Gym', 'Fitness Club', 'Gym Center', 'Training Gym',
                    'Fitness Studio', 'Gym Pro', 'Fitness Pro', 'Gym Club',
                    'Workout Center', 'Fitness Place', 'Gym Studio', 'Fitness Facility',
                    'Gym Training', 'Fitness House', 'Gym House', 'Fitness Spot',
                    'Gym Spot', 'Fitness Works'
                ]
            },
            nutritionists: {
                name: 'Nutritionists',
                variations: [
                    'Nutritionist', 'Nutrition', 'Dietitian', 'Nutrition Coach',
                    'Nutrition Specialist', 'Nutrition Expert', 'Nutrition Consultant',
                    'Nutrition Service', 'Nutrition Pro', 'Diet Coach',
                    'Nutrition Counselor', 'Nutrition Clinic', 'Nutrition Center',
                    'Nutrition Wellness', 'Nutrition Health', 'Nutrition Advisor',
                    'Nutrition Therapy', 'Nutrition Solutions', 'Nutrition Studio',
                    'Nutrition Practice', 'Nutrition Guidance', 'Nutrition Planning'
                ]
            },
            acupuncture: {
                name: 'Acupuncture',
                variations: [
                    'Acupuncture', 'Acupuncturist', 'Acupuncture Clinic',
                    'Acupuncture Center', 'Acupuncture Service', 'Acupuncture Therapy',
                    'Acupuncture Wellness', 'Acupuncture Health', 'Acupuncture Pro',
                    'Acupuncture Specialist', 'Acupuncture Expert', 'Acupuncture Treatment',
                    'Acupuncture Studio', 'Acupuncture Practice', 'Acupuncture Office',
                    'Acupuncture Healing', 'Acupuncture Care', 'Acupuncture Solutions',
                    'Acupuncture Medicine', 'Acupuncture Doctor', 'Acupuncture Therapist'
                ]
            },
            mentalHealth: {
                name: 'Mental Health',
                variations: [
                    'Mental Health', 'Therapy', 'Counseling', 'Therapist', 'Counselor',
                    'Mental Health Clinic', 'Therapy Center', 'Counseling Center',
                    'Mental Health Service', 'Therapy Practice', 'Counseling Service',
                    'Mental Wellness', 'Therapy Office', 'Counseling Office',
                    'Mental Health Pro', 'Therapy Pro', 'Counseling Pro',
                    'Mental Health Specialist', 'Therapy Specialist',
                    'Counseling Specialist', 'Mental Health Counselor',
                    'Therapy Solutions', 'Mental Health Therapist'
                ]
            },
            petGroomers: {
                name: 'Pet Groomers',
                variations: [
                    'Pet Grooming', 'Pet Groomer', 'Dog Grooming', 'Grooming',
                    'Dog Groomer', 'Pet Spa', 'Grooming Salon', 'Pet Salon',
                    'Dog Spa', 'Grooming Service', 'Pet Grooming Salon',
                    'Dog Grooming Salon', 'Grooming Studio', 'Pet Grooming Service',
                    'Grooming Shop', 'Pet Grooming Spa', 'Grooming Pro', 'Pet Care',
                    'Dog Care', 'Grooming Specialist', 'Pet Grooming Studio',
                    'Grooming Expert', 'Pet Grooming Pro'
                ]
            },
            veterinarians: {
                name: 'Veterinarians',
                variations: [
                    'Veterinarian', 'Vet', 'Veterinary', 'Vet Clinic', 'Animal Hospital',
                    'Vet Hospital', 'Veterinary Clinic', 'Animal Clinic', 'Vet Center',
                    'Veterinary Hospital', 'Pet Hospital', 'Vet Service',
                    'Veterinary Service', 'Animal Care', 'Vet Care', 'Veterinary Care',
                    'Pet Clinic', 'Vet Office', 'Veterinary Office', 'Animal Doctor',
                    'Pet Doctor', 'Vet Pro', 'Veterinary Center'
                ]
            },
            daycareCenters: {
                name: 'Daycare Centers',
                variations: [
                    'Daycare', 'Daycare Center', 'Childcare', 'Childcare Center',
                    'Preschool', 'Nursery', 'Daycare Service', 'Childcare Service',
                    'Kids Daycare', 'Children Daycare', 'Daycare Pro', 'Childcare Pro',
                    'Daycare School', 'Childcare Facility', 'Early Learning',
                    'Daycare Academy', 'Childcare Academy', 'Daycare Learning',
                    'Kids Center', 'Children Center', 'Daycare Program',
                    'Childcare Program', 'Daycare Education'
                ]
            },
            tutoringCenters: {
                name: 'Tutoring Centers',
                variations: [
                    'Tutoring Center', 'Learning Center', 'Education Center',
                    'Tutoring Academy', 'Learning Academy', 'Tutoring School',
                    'Study Center', 'Academic Center', 'Tutoring Hub', 'Learning Hub',
                    'Tutoring Place', 'Education Academy', 'Tutoring Facility',
                    'Learning Facility', 'Tutoring Program', 'Learning Program',
                    'Tutoring Institute', 'Education Institute', 'Tutoring Service Center',
                    'Learning Service', 'Tutoring Education', 'Academic Tutoring'
                ]
            },
            musicLessons: {
                name: 'Music Lessons',
                variations: [
                    'Music Lessons', 'Music School', 'Music Teacher', 'Music Studio',
                    'Music Academy', 'Music Instruction', 'Music Class', 'Music Education',
                    'Music Tutor', 'Music Training', 'Music Center', 'Music Institute',
                    'Piano Lessons', 'Guitar Lessons', 'Music Lesson Studio',
                    'Music Teaching', 'Music Instructor', 'Music Coach', 'Music Pro',
                    'Music Learning', 'Music Tutoring', 'Music Program',
                    'Music Service', 'Music Workshop'
                ]
            },
            danceStudios: {
                name: 'Dance Studios',
                variations: [
                    'Dance Studio', 'Dance', 'Dance School', 'Dance Academy',
                    'Dance Class', 'Dance Center', 'Dance Company', 'Dance Lessons',
                    'Dance Instruction', 'Dance Training', 'Dance House', 'Dance Space',
                    'Dance Room', 'Dance Floor', 'Dance Institute', 'Dance Education',
                    'Dance Teacher', 'Dance Pro', 'Dance Workshop', 'Dance Program',
                    'Dance Collective', 'Dance Boutique', 'Dance Works'
                ]
            },
            martialArts: {
                name: 'Martial Arts',
                variations: [
                    'Martial Arts', 'Karate', 'Taekwondo', 'Kung Fu', 'Jiu Jitsu',
                    'MMA', 'Kickboxing', 'Martial Arts School', 'Dojo',
                    'Martial Arts Academy', 'Martial Arts Studio', 'Martial Arts Center',
                    'Martial Arts Training', 'Fighting Gym', 'Combat Sports',
                    'Martial Arts Class', 'Self Defense', 'Martial Arts Instruction',
                    'Martial Arts Pro', 'Martial Arts Gym', 'Martial Arts Institute',
                    'Martial Arts Program', 'Martial Arts Club'
                ]
            },
            swimmingLessons: {
                name: 'Swimming Lessons',
                variations: [
                    'Swimming Lessons', 'Swim School', 'Swim Lessons', 'Swimming School',
                    'Swim Academy', 'Swimming Class', 'Swim Class', 'Swimming Instruction',
                    'Swim Instruction', 'Swimming Teacher', 'Swim Coach',
                    'Swimming Coach', 'Swim Training', 'Swimming Training',
                    'Swim Center', 'Swimming Center', 'Aquatic Center', 'Swim Program',
                    'Swimming Program', 'Swim Club', 'Swimming Club', 'Swim Pro',
                    'Swimming Academy'
                ]
            },
            dryCleaners: {
                name: 'Dry Cleaners',
                variations: [
                    'Dry Cleaners', 'Dry Cleaning', 'Cleaners', 'Dry Clean',
                    'Cleaning Service', 'Dry Cleaning Service', 'Laundry Cleaners',
                    'Dry Cleaner Shop', 'Cleaning Pro', 'Dry Cleaning Pro',
                    'Cleaners Service', 'Dry Cleaning Company', 'Cleaning Specialist',
                    'Dry Cleaning Specialist', 'Cleaners Pro', 'Dry Cleaning Expert',
                    'Cleaning Center', 'Dry Cleaning Center', 'Cleaners Shop',
                    'Dry Cleaning Business', 'Cleaning Store', 'Dry Cleaning Store'
                ]
            },
            laundromats: {
                name: 'Laundromats',
                variations: [
                    'Laundromat', 'Laundry', 'Coin Laundry', 'Wash Fold',
                    'Laundry Service', 'Laundromat Service', 'Self Service Laundry',
                    'Laundry Center', 'Wash Dry', 'Laundry Mat', 'Laundry Shop',
                    'Wash Center', 'Laundry Room', 'Laundromat Center', 'Laundry Pro',
                    'Wash Dry Fold', 'Laundry Facility', 'Laundromat Pro',
                    'Laundry Place', 'Wash House', 'Laundry Station',
                    'Laundromat Shop', 'Wash Service'
                ]
            },
            tailors: {
                name: 'Tailors',
                variations: [
                    'Tailor', 'Tailoring', 'Alterations', 'Tailor Shop', 'Custom Tailor',
                    'Tailoring Service', 'Alterations Service', 'Tailor Alterations',
                    'Clothing Alterations', 'Custom Tailoring', 'Tailor Pro',
                    'Tailoring Pro', 'Alterations Pro', 'Tailor Service',
                    'Tailoring Shop', 'Alterations Shop', 'Tailor Expert',
                    'Tailoring Expert', 'Alterations Expert', 'Tailor Specialist',
                    'Custom Suits', 'Tailor Studio', 'Tailoring Studio'
                ]
            },
            shoeRepair: {
                name: 'Shoe Repair',
                variations: [
                    'Shoe Repair', 'Shoe Service', 'Shoe Fix', 'Cobbler', 'Shoe Shop',
                    'Shoe Repair Shop', 'Shoe Repair Service', 'Shoe Restoration',
                    'Shoe Care', 'Shoe Doctor', 'Shoe Repair Pro', 'Shoe Specialist',
                    'Shoe Repair Specialist', 'Shoe Expert', 'Shoe Repair Expert',
                    'Shoe Maintenance', 'Shoe Repair Center', 'Shoe Clinic',
                    'Shoe Repair Solutions', 'Shoe Works', 'Shoe Repair Store',
                    'Shoe Repair Business', 'Shoe Services'
                ]
            },
            jewelryRepair: {
                name: 'Jewelry Repair',
                variations: [
                    'Jewelry Repair', 'Jeweler', 'Jewelry Service', 'Jewelry Fix',
                    'Jewelry Shop', 'Jewelry Repair Shop', 'Jewelry Repair Service',
                    'Jewelry Restoration', 'Watch Jewelry', 'Jewelry Doctor',
                    'Jewelry Repair Pro', 'Jewelry Specialist', 'Jewelry Repair Specialist',
                    'Jewelry Expert', 'Jewelry Repair Expert', 'Jewelry Maintenance',
                    'Jewelry Repair Center', 'Jewelry Clinic', 'Jewelry Repair Solutions',
                    'Jewelry Works', 'Jewelry Repair Store', 'Jewelry Repair Business'
                ]
            },
            watchRepair: {
                name: 'Watch Repair',
                variations: [
                    'Watch Repair', 'Watch Service', 'Watch Fix', 'Watchmaker',
                    'Watch Shop', 'Watch Repair Shop', 'Watch Repair Service',
                    'Watch Restoration', 'Timepiece Repair', 'Watch Doctor',
                    'Watch Repair Pro', 'Watch Specialist', 'Watch Repair Specialist',
                    'Watch Expert', 'Watch Repair Expert', 'Watch Maintenance',
                    'Watch Repair Center', 'Watch Clinic', 'Watch Repair Solutions',
                    'Watch Works', 'Watch Repair Store', 'Watch Repair Business'
                ]
            },
            keyMakers: {
                name: 'Key Makers',
                variations: [
                    'Key Maker', 'Key Service', 'Key Shop', 'Key Cutting',
                    'Key Duplication', 'Locksmith Keys', 'Key Copy', 'Key Store',
                    'Key Making', 'Key Specialist', 'Key Pro', 'Key Expert',
                    'Key Solutions', 'Key Center', 'Key Cutting Service',
                    'Key Duplicate', 'Key Making Service', 'Key Business',
                    'Key Company', 'Key Works', 'Key Replacement', 'Key Services',
                    'Key Cutting Shop'
                ]
            },
            locksmiths: {
                name: 'Locksmiths',
                variations: [
                    'Locksmith', 'Locksmith Service', 'Lock Service', 'Locksmith Pro',
                    'Lock Repair', 'Locksmith Shop', 'Emergency Locksmith',
                    'Locksmith Company', 'Lock Specialist', 'Locksmith Specialist',
                    'Lock Pro', 'Locksmith Expert', 'Lock Expert', 'Locksmith Solutions',
                    'Lock Solutions', 'Locksmith 24/7', 'Mobile Locksmith',
                    'Locksmith Emergency', 'Lock Company', 'Locksmith Business',
                    'Lock Shop', 'Locksmith Center', 'Lock Works'
                ]
            },
            florists: {
                name: 'Florists',
                variations: [
                    'Florist', 'Flower Shop', 'Flowers', 'Floral', 'Flower Store',
                    'Floral Design', 'Flower Delivery', 'Florist Shop', 'Floral Shop',
                    'Flower Boutique', 'Floral Boutique', 'Flower Studio',
                    'Floral Studio', 'Flower Service', 'Floral Service',
                    'Flower Arrangements', 'Floral Arrangements', 'Flower Pro',
                    'Floral Pro', 'Flower Specialist', 'Floral Specialist',
                    'Flower Company', 'Floral Company'
                ]
            },
            giftShops: {
                name: 'Gift Shops',
                variations: [
                    'Gift Shop', 'Gifts', 'Gift Store', 'Gift Boutique', 'Gift Gallery',
                    'Gift Emporium', 'Gift Center', 'Gift House', 'Gift Place',
                    'Gift Company', 'Gift Studio', 'Gift Market', 'Gift Corner',
                    'Gift Basket', 'Gift Items', 'Gift Pro', 'Gift Specialist',
                    'Gift Expert', 'Gift Service', 'Gift Solutions', 'Gift Works',
                    'Gift Retail', 'Gift Merchandise'
                ]
            },
            antiqueStores: {
                name: 'Antique Stores',
                variations: [
                    'Antique Store', 'Antiques', 'Antique Shop', 'Vintage Store',
                    'Antique Dealer', 'Antique Gallery', 'Vintage Shop', 'Antique Mall',
                    'Antique Market', 'Collectibles', 'Antique Center', 'Vintage Market',
                    'Antique Boutique', 'Vintage Boutique', 'Antique Emporium',
                    'Antique House', 'Vintage Finds', 'Antique Treasures',
                    'Antique Company', 'Vintage Company', 'Antique Specialist',
                    'Vintage Specialist', 'Antique Expert'
                ]
            },
            thriftStores: {
                name: 'Thrift Stores',
                variations: [
                    'Thrift Store', 'Thrift Shop', 'Thrift', 'Secondhand Store',
                    'Resale Shop', 'Thrift Boutique', 'Consignment Shop', 'Used Goods',
                    'Thrift Market', 'Secondhand Shop', 'Thrift Finds', 'Resale Store',
                    'Thrift Center', 'Vintage Thrift', 'Thrift Treasures',
                    'Thrift Company', 'Secondhand Market', 'Thrift Emporium',
                    'Resale Boutique', 'Thrift Deals', 'Thrift Bargains',
                    'Thrift Outlet', 'Thrift Warehouse'
                ]
            },
            pawnShops: {
                name: 'Pawn Shops',
                variations: [
                    'Pawn Shop', 'Pawn', 'Pawn Store', 'Pawn Broker', 'Pawn Service',
                    'Cash Pawn', 'Pawn Loans', 'Pawn Center', 'Pawn Company',
                    'Pawn Business', 'Pawn Pro', 'Pawn Specialist', 'Pawn Expert',
                    'Pawn Solutions', 'Pawn Dealer', 'Pawn Trade', 'Pawn Exchange',
                    'Pawn Mart', 'Pawn Outlet', 'Pawn House', 'Pawn Place',
                    'Pawn Retail', 'Pawn Services'
                ]
            },
            bookstores: {
                name: 'Bookstores',
                variations: [
                    'Bookstore', 'Books', 'Book Shop', 'Bookshop', 'Book Store',
                    'Book Seller', 'Book House', 'Book Center', 'Book Gallery',
                    'Book Boutique', 'Book Emporium', 'Book Market', 'Book Corner',
                    'Book Place', 'Book Company', 'Book Dealer', 'Book Retail',
                    'Book Outlet', 'Book Warehouse', 'Book Specialist', 'Book Expert',
                    'Book Collection', 'Book Works'
                ]
            },
            libraries: {
                name: 'Libraries',
                variations: [
                    'Library', 'Public Library', 'Community Library', 'Library Center',
                    'Library Services', 'Book Library', 'Library Branch',
                    'Library System', 'Local Library', 'Library Resource',
                    'Library Collection', 'Library Reference', 'Library Research',
                    'Library Learning', 'Library Education', 'Library Community',
                    'Library Program', 'Library Facility', 'Library Institution',
                    'Library Organization', 'Library Association', 'Library Network',
                    'Library Hub'
                ]
            },
            artGalleries: {
                name: 'Art Galleries',
                variations: [
                    'Art Gallery', 'Gallery', 'Art Studio', 'Art Space', 'Art Exhibit',
                    'Art Exhibition', 'Art Museum', 'Art Center', 'Art House',
                    'Art Boutique', 'Gallery Space', 'Art Showroom', 'Art Collection',
                    'Art Dealer', 'Gallery Boutique', 'Art Company', 'Gallery Studio',
                    'Art Room', 'Gallery House', 'Art Place', 'Gallery Center',
                    'Art Works', 'Gallery Works'
                ]
            },
            constructionCompanies: {
                name: 'Construction Companies',
                variations: [
                    'Construction', 'Construction Company', 'Construction Service',
                    'Construction Contractor', 'Builder', 'Construction Pro',
                    'Building Company', 'Construction Firm', 'Construction Specialist',
                    'Construction Expert', 'Construction Corp', 'Construction Group',
                    'Construction Team', 'Construction Solutions', 'General Contractor',
                    'Construction Business', 'Construction Works', 'Construction Services',
                    'Building Contractor', 'Construction Crew', 'Construction Development',
                    'Construction Management', 'Construction Enterprise'
                ]
            },
            contractors: {
                name: 'Contractors',
                variations: [
                    'Contractor', 'General Contractor', 'Contracting', 'Contractor Service',
                    'Contracting Company', 'Contractor Pro', 'Contracting Pro',
                    'Contractor Specialist', 'Contracting Specialist', 'Contractor Expert',
                    'Contracting Expert', 'Contractor Firm', 'Contracting Firm',
                    'Contractor Company', 'Contracting Service', 'Contractor Business',
                    'Contracting Business', 'Contractor Solutions', 'Contracting Solutions',
                    'Contractor Group', 'Contracting Group', 'Contractor Works',
                    'Contracting Works'
                ]
            },
            architects: {
                name: 'Architects',
                variations: [
                    'Architect', 'Architecture', 'Architectural', 'Architect Firm',
                    'Architecture Firm', 'Architectural Design', 'Architect Service',
                    'Architecture Service', 'Architect Office', 'Architecture Office',
                    'Architect Studio', 'Architecture Studio', 'Architect Company',
                    'Architecture Company', 'Architect Pro', 'Architecture Pro',
                    'Architect Specialist', 'Architecture Specialist', 'Architect Expert',
                    'Architecture Expert', 'Architect Group', 'Architecture Group',
                    'Architect Design', 'Architectural Firm'
                ]
            },
            engineers: {
                name: 'Engineers',
                variations: [
                    'Engineer', 'Engineering', 'Engineering Firm', 'Engineering Service',
                    'Engineer Service', 'Engineering Company', 'Engineer Company',
                    'Engineering Pro', 'Engineer Pro', 'Engineering Specialist',
                    'Engineer Specialist', 'Engineering Expert', 'Engineer Expert',
                    'Engineering Solutions', 'Engineer Solutions', 'Engineering Consultant',
                    'Engineer Consultant', 'Engineering Office', 'Engineer Office',
                    'Engineering Group', 'Engineer Group', 'Engineering Team',
                    'Engineer Team', 'Engineering Corp'
                ]
            },
            surveyors: {
                name: 'Surveyors',
                variations: [
                    'Surveyor', 'Surveying', 'Land Surveyor', 'Surveying Service',
                    'Surveyor Service', 'Surveying Company', 'Surveyor Company',
                    'Land Surveying', 'Surveying Pro', 'Surveyor Pro',
                    'Surveying Specialist', 'Surveyor Specialist', 'Surveying Expert',
                    'Surveyor Expert', 'Surveying Firm', 'Surveyor Firm',
                    'Surveying Solutions', 'Surveyor Solutions', 'Surveying Consultant',
                    'Surveyor Consultant', 'Surveying Office', 'Surveyor Office',
                    'Surveying Group'
                ]
            },
            inspectors: {
                name: 'Inspectors',
                variations: [
                    'Inspector', 'Inspection', 'Inspection Service', 'Inspector Service',
                    'Home Inspector', 'Inspection Company', 'Inspector Company',
                    'Inspection Pro', 'Inspector Pro', 'Inspection Specialist',
                    'Inspector Specialist', 'Inspection Expert', 'Inspector Expert',
                    'Building Inspector', 'Property Inspector', 'Inspection Firm',
                    'Inspector Firm', 'Inspection Solutions', 'Inspector Solutions',
                    'Inspection Consultant', 'Inspector Consultant', 'Inspection Office',
                    'Inspector Office'
                ]
            },
            appraisers: {
                name: 'Appraisers',
                variations: [
                    'Appraiser', 'Appraisal', 'Appraisal Service', 'Appraiser Service',
                    'Property Appraiser', 'Appraisal Company', 'Appraiser Company',
                    'Real Estate Appraiser', 'Appraisal Pro', 'Appraiser Pro',
                    'Appraisal Specialist', 'Appraiser Specialist', 'Appraisal Expert',
                    'Appraiser Expert', 'Home Appraiser', 'Appraisal Firm',
                    'Appraiser Firm', 'Appraisal Solutions', 'Appraiser Solutions',
                    'Appraisal Consultant', 'Appraiser Consultant', 'Appraisal Office',
                    'Appraiser Office'
                ]
            },
            notaries: {
                name: 'Notaries',
                variations: [
                    'Notary', 'Notary Public', 'Notary Service', 'Notary Signing',
                    'Mobile Notary', 'Notary Pro', 'Notary Services', 'Notary Company',
                    'Notary Specialist', 'Notary Expert', 'Notary Office',
                    'Notary Signing Agent', 'Notary Business', 'Notary Solutions',
                    'Notary Consultant', 'Notary Professional', 'Notary Center',
                    'Notary Firm', 'Notary Group', 'Notary Works',
                    'Notary Signing Service', 'Notary Mobile', 'Notary Public Service'
                ]
            }
        };

        // ========================================
        // TAB NAVIGATION
        // ========================================
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active state from all tabs
            document.querySelectorAll('.tab-btn').forEach(tab => {
                tab.classList.remove('border-blue-500', 'text-blue-600');
                tab.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected tab content
            document.getElementById(`${tabName}-content`).classList.remove('hidden');
            
            // Set active state on selected tab
            const activeTab = document.getElementById(`${tabName}-tab`);
            activeTab.classList.remove('border-transparent', 'text-gray-500');
            activeTab.classList.add('border-blue-500', 'text-blue-600');
            
            // Update settings tab stats when switching to it
            if (tabName === 'settings') {
                updateSettingsStats();
            }
        }

        function updateSettingsStats() {
            // Count total results across all history
            let totalResults = 0;
            searchHistoryWithResults.forEach(session => {
                totalResults += session.results.length;
            });
            
            document.getElementById('totalResultsStored').textContent = `${totalResults} results`;
            document.getElementById('totalSessions').textContent = `${searchSessionCount} sessions`;
        }

        // ========================================
        // LOCALSTORAGE KEYS
        // ========================================
        const STORAGE_KEYS = {
            API_KEY: 'igFinder_apiKey',
            SEARCH_ENGINE_ID: 'igFinder_searchEngineId',
            SEARCH_HISTORY: 'igFinder_searchHistory',
            SESSION_COUNT: 'igFinder_sessionCount',
            PLACES_API_KEY: 'igFinder_placesApiKey'
        };

        // ========================================
        // PERSISTENT STORAGE FOR HISTORY
        // ========================================
        let currentSearchResults = []; // Only holds current search results
        let searchSessionCount = 0;
        let searchHistoryWithResults = []; // Holds all historical searches
        let selectedNiches = new Map();
        let selectedNanoNiches = new Map();

        // ========================================
        // DYNAMIC NICHE INITIALIZATION
        // ========================================
        function initializeNiches() {
            const container = document.querySelector('.niche-buttons');
            let html = '';
            
            Object.entries(niches).forEach(([key, niche]) => {
                html += `
                    <button id="${key}Btn" data-niche="${key}" class="niche-btn bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition duration-200 text-sm">
                        ${niche.name}
                    </button>
                `;
            });
            
            container.innerHTML = html;
        }

        function initializeNanoBananaNiches() {
            const container = document.querySelector('.nano-niche-buttons');
            if (!container) return;
            let html = '';
            Object.entries(nanoBananaNiches).forEach(([key, niche]) => {
                html += `
                    <button id="nano-${key}Btn" data-nano-niche="${key}" class="nano-niche-btn bg-yellow-500 text-white px-4 py-2 rounded-md hover:bg-yellow-600 transition duration-200 text-sm">
                        ${niche.name}
                    </button>
                `;
            });
            container.innerHTML = html;
        }

        // ========================================
        // LOCATION UI FUNCTIONS
        // ========================================
        function initializeCountriesAndCities() {
            const container = document.getElementById('countriesContainer');
            let html = '';
            
            Object.keys(countriesAndCities).forEach((country, index) => {
                const cities = countriesAndCities[country];
                const countryId = `country-${index}`;
                const cityCount = typeof cities === 'object' ? Object.keys(cities).length : cities.length;
                
                html += `
                    <div class="border border-gray-200 rounded-lg overflow-hidden">
                        <div class="bg-gray-100 px-4 py-2 cursor-pointer hover:bg-gray-200 transition-colors flex justify-between items-center"
                             onclick="toggleCountry('${countryId}')">
                            <div class="flex items-center gap-2">
                                <span id="${countryId}-arrow" class="text-gray-500 transition-transform">▶</span>
                                <span class="font-medium">${country}</span>
                                <span class="text-xs text-gray-500">(${cityCount} cities)</span>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="event.stopPropagation(); selectAllInCountry('${country}')" 
                                        class="text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">
                                    Select All
                                </button>
                                <button onclick="event.stopPropagation(); deselectAllInCountry('${country}')" 
                                        class="text-xs bg-gray-500 text-white px-2 py-1 rounded hover:bg-gray-600">
                                    Deselect All
                                </button>
                            </div>
                        </div>
                        <div id="${countryId}-cities" class="hidden px-4 py-2 bg-white">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                `;
                
                if (typeof cities === 'object') {
                    Object.entries(cities).forEach(([city, state], cityIndex) => {
                        const cityId = `${countryId}-city-${cityIndex}`;
                        const cityWithState = `${city} (${state})`;
                        html += `
                            <label class="flex items-center text-sm cursor-pointer hover:bg-gray-50 p-1 rounded">
                                <input type="checkbox" id="${cityId}" value="${city}" 
                                       data-state="${state}"
                                       data-country="${country}"
                                       onchange="toggleCity('${city}', '${state}', '${country}')"
                                       class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <span>${cityWithState}</span>
                            </label>
                        `;
                    });
                } else {
                    cities.forEach((city, cityIndex) => {
                        const cityId = `${countryId}-city-${cityIndex}`;
                        html += `
                            <label class="flex items-center text-sm cursor-pointer hover:bg-gray-50 p-1 rounded">
                                <input type="checkbox" id="${cityId}" value="${city}" 
                                       data-country="${country}"
                                       onchange="toggleCity('${city}', '', '${country}')"
                                       class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <span>${city}</span>
                            </label>
                        `;
                    });
                }
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function toggleCountry(countryId) {
            const citiesDiv = document.getElementById(`${countryId}-cities`);
            const arrow = document.getElementById(`${countryId}-arrow`);
            
            if (citiesDiv.classList.contains('hidden')) {
                citiesDiv.classList.remove('hidden');
                arrow.style.transform = 'rotate(90deg)';
            } else {
                citiesDiv.classList.add('hidden');
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        function toggleCity(city, state, country) {
            const key = state ? `${city}, ${state}` : city;
            if (selectedCities.has(key)) {
                selectedCities.delete(key);
            } else {
                selectedCities.set(key, {city, state, country});
            }
            updateSelectedCitiesCount();
        }

        function selectAllInCountry(country) {
            const cities = countriesAndCities[country];
            if (typeof cities === 'object') {
                Object.entries(cities).forEach(([city, state]) => {
                    const key = `${city}, ${state}`;
                    selectedCities.set(key, {city, state, country});
                    const checkbox = document.querySelector(`input[value="${city}"][data-state="${state}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            } else {
                cities.forEach(city => {
                    selectedCities.set(city, {city, state: '', country});
                    const checkbox = document.querySelector(`input[value="${city}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            updateSelectedCitiesCount();
        }

        function deselectAllInCountry(country) {
            const cities = countriesAndCities[country];
            if (typeof cities === 'object') {
                Object.entries(cities).forEach(([city, state]) => {
                    const key = `${city}, ${state}`;
                    selectedCities.delete(key);
                    const checkbox = document.querySelector(`input[value="${city}"][data-state="${state}"]`);
                    if (checkbox) checkbox.checked = false;
                });
            } else {
                cities.forEach(city => {
                    selectedCities.delete(city);
                    const checkbox = document.querySelector(`input[value="${city}"]`);
                    if (checkbox) checkbox.checked = false;
                });
            }
            updateSelectedCitiesCount();
        }

        function selectAllCities() {
            Object.entries(countriesAndCities).forEach(([country, cities]) => {
                if (typeof cities === 'object') {
                    Object.entries(cities).forEach(([city, state]) => {
                        const key = `${city}, ${state}`;
                        selectedCities.set(key, {city, state, country});
                        const checkbox = document.querySelector(`input[value="${city}"][data-state="${state}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                } else {
                    cities.forEach(city => {
                        selectedCities.set(city, {city, state: '', country});
                        const checkbox = document.querySelector(`input[value="${city}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
            });
            updateSelectedCitiesCount();
        }

        function deselectAllCities() {
            selectedCities.clear();
            document.querySelectorAll('#countriesContainer input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateSelectedCitiesCount();
        }

        function updateSelectedCitiesCount() {
            document.getElementById('selectedCitiesCount').textContent = selectedCities.size;
        }

        function getSelectedLocations() {
            return Array.from(selectedCities.values());
        }

        // ========================================
        // LOCALSTORAGE FUNCTIONS
        // ========================================
        function saveToLocalStorage() {
            try {
                localStorage.setItem(STORAGE_KEYS.SEARCH_HISTORY, JSON.stringify(searchHistoryWithResults));
                localStorage.setItem(STORAGE_KEYS.SESSION_COUNT, searchSessionCount.toString());
                console.log('Data saved to localStorage');
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                showInfoMessage('Warning: Could not save data to browser storage', 'warning');
            }
        }

        function loadFromLocalStorage() {
            try {
                const savedApiKey = localStorage.getItem(STORAGE_KEYS.API_KEY);
                const savedSearchEngineId = localStorage.getItem(STORAGE_KEYS.SEARCH_ENGINE_ID);
                const savedPlacesApiKey = localStorage.getItem(STORAGE_KEYS.PLACES_API_KEY);
                
                if (savedApiKey) {
                    document.getElementById('apiKey').value = savedApiKey;
                }
                if (savedSearchEngineId) {
                    document.getElementById('searchEngineId').value = savedSearchEngineId;
                }
                if (savedPlacesApiKey) {
                    const placesApiKeyInput = document.getElementById('placesApiKey');
                    if (placesApiKeyInput) placesApiKeyInput.value = savedPlacesApiKey;
                }
                
                const savedHistory = localStorage.getItem(STORAGE_KEYS.SEARCH_HISTORY);
                const savedSessionCount = localStorage.getItem(STORAGE_KEYS.SESSION_COUNT);
                
                if (savedHistory) {
                    searchHistoryWithResults = JSON.parse(savedHistory);
                }
                if (savedSessionCount) {
                    searchSessionCount = parseInt(savedSessionCount);
                }
                
                console.log(`Loaded from localStorage: ${searchHistoryWithResults.length} history entries`);
                
                if (savedApiKey && savedSearchEngineId) {
                    document.getElementById('apiSaveStatus').textContent = '✓ API settings loaded from saved data';
                    setTimeout(() => {
                        document.getElementById('apiSaveStatus').textContent = '';
                    }, 3000);
                }
                
            } catch (error) {
                console.error('Error loading from localStorage:', error);
            }
        }

        function saveApiSettings() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const searchEngineId = document.getElementById('searchEngineId').value.trim();
            const placesApiKeyInput = document.getElementById('placesApiKey');
            const placesApiKey = placesApiKeyInput ? placesApiKeyInput.value.trim() : '';
            
            if (apiKey) {
                localStorage.setItem(STORAGE_KEYS.API_KEY, apiKey);
            }
            if (searchEngineId) {
                localStorage.setItem(STORAGE_KEYS.SEARCH_ENGINE_ID, searchEngineId);
            }
            if (placesApiKey) {
                localStorage.setItem(STORAGE_KEYS.PLACES_API_KEY, placesApiKey);
            }
            
            if (apiKey || searchEngineId || placesApiKey) {
                document.getElementById('apiSaveStatus').textContent = '✓ API settings saved';
                setTimeout(() => {
                    document.getElementById('apiSaveStatus').textContent = '';
                }, 2000);
            }
        }

        function clearAllSavedData() {
            if (confirm('This will clear ALL saved data including API settings, results, and history. Are you sure?')) {
                Object.values(STORAGE_KEYS).forEach(key => {
                    localStorage.removeItem(key);
                });
                
                currentSearchResults = [];
                searchHistoryWithResults = [];
                searchSessionCount = 0;
                
                document.getElementById('apiKey').value = '';
                document.getElementById('searchEngineId').value = '';
                updateCurrentResultsDisplay();
                updateSearchHistory();
                
                showInfoMessage('All saved data has been cleared', 'info');
                console.log('All saved data cleared from localStorage and memory');
            }
        }

        // ========================================
        // NICHE TOGGLE FUNCTIONALITY
        // ========================================
        function toggleNiche(nicheKey) {
            const niche = niches[nicheKey];
            if (!niche) return;
            
            const button = document.querySelector(`[data-niche="${nicheKey}"]`);
            
            if (selectedNiches.has(nicheKey)) {
                selectedNiches.delete(nicheKey);
                button.classList.remove('bg-blue-600', 'ring-2', 'ring-blue-400');
                button.classList.add('bg-gray-600');
                console.log(`Deselected niche: ${niche.name}`);
            } else {
                selectedNiches.set(nicheKey, niche);
                button.classList.remove('bg-gray-600');
                button.classList.add('bg-blue-600', 'ring-2', 'ring-blue-400');
                console.log(`Selected niche: ${niche.name}`);
            }
            
            updateSelectedNichesDisplay();
        }
        
        function updateSelectedNichesDisplay() {
            const selectedNichesList = document.getElementById('selectedNichesList');
            
            const names = new Set();
            selectedNiches.forEach(n => names.add(n.name));
            if (typeof selectedNanoNiches !== 'undefined' && selectedNanoNiches instanceof Map) {
                selectedNanoNiches.forEach(n => names.add(n.name));
            }
            
            if (names.size === 0) {
                selectedNichesList.textContent = 'None';
                selectedNichesList.className = 'text-gray-500';
            } else {
                selectedNichesList.textContent = Array.from(names).join(', ');
                selectedNichesList.className = 'text-blue-600 font-medium';
            }
        }

        function toggleNanoNiche(nicheKey) {
            const niche = nanoBananaNiches[nicheKey];
            if (!niche) return;

            const button = document.querySelector(`[data-nano-niche="${nicheKey}"]`);

            if (selectedNanoNiches.has(nicheKey)) {
                selectedNanoNiches.delete(nicheKey);
                if (button) {
                    button.classList.remove('bg-blue-600', 'ring-2', 'ring-blue-400');
                    button.classList.add('bg-gray-600');
                }
                console.log(`Deselected nano niche: ${niche.name}`);
            } else {
                selectedNanoNiches.set(nicheKey, niche);
                if (button) {
                    button.classList.remove('bg-gray-600');
                    button.classList.add('bg-blue-600', 'ring-2', 'ring-blue-400');
                }
                console.log(`Selected nano niche: ${niche.name}`);
                // Auto-run searches using only selected Nano Banana niches
                performSearches({ nicheSetOverride: selectedNanoNiches, sessionLabel: 'Nano Banana Niches' });
            }

            updateSelectedNanoNichesDisplay();
        }

        function updateSelectedNanoNichesDisplay() {
            const listEl = document.getElementById('selectedNanoNichesList');
            if (!listEl) return;
            if (selectedNanoNiches.size === 0) {
                listEl.textContent = 'None';
                listEl.className = 'text-gray-500';
                return;
            }
            const names = Array.from(selectedNanoNiches.values()).map(n => n.name);
            listEl.textContent = names.join(', ');
            listEl.className = 'text-blue-600 font-medium';
        }

        // ========================================
        // SEARCH HISTORY RECALL FUNCTIONALITY
        // ========================================
        function recallSearchSession(sessionId) {
            const session = searchHistoryWithResults.find(s => s.sessionId === sessionId);
            if (!session) {
                console.error(`Session ${sessionId} not found`);
                return;
            }
            
            // Switch to Search tab to show results
            switchTab('search');
            
            // Clear current results and replace with recalled results
            currentSearchResults = [...session.results];
            
            console.log(`Recalling session ${sessionId} with ${session.results.length} results`);
            
            // Update the display with recalled results
            updateCurrentResultsDisplay(session);
            
            showInfoMessage(
                `Recalled ${session.results.length} results from "${session.displayName}" (Session #${session.sessionNumber})`,
                'info'
            );
        }

        // ========================================
        // DEDUPLICATION FUNCTIONS
        // ========================================
        
        // Normalize business name for comparison
        function normalizeBusinessName(name) {
            if (!name) return '';
            // Remove special characters, extra spaces, and convert to lowercase
            return name.toLowerCase()
                .replace(/[^\w\s]/g, '') // Remove special characters
                .replace(/\s+/g, ' ') // Replace multiple spaces with single space
                .trim();
        }
        
        // Normalize username for comparison
        function normalizeUsername(username) {
            if (!username) return '';
            return username.toLowerCase().trim();
        }
        
        // Normalize URL for comparison
        function normalizeUrl(url) {
            if (!url) return '';
            return url.toLowerCase().trim();
        }
        
        // Get all historical results from previous searches
        function getAllHistoricalResults() {
            const allResults = [];
            searchHistoryWithResults.forEach(session => {
                session.results.forEach(result => {
                    allResults.push(result);
                });
            });
            return allResults;
        }
        
        // Check if a result already exists in history
        function isResultInHistory(result, allHistoricalResults) {
            const normalizedUsername = normalizeUsername(result.username);
            const normalizedBusinessName = normalizeBusinessName(result.businessName);
            const normalizedUrl = normalizeUrl(result.url);
            
            return allHistoricalResults.some(historicalResult => {
                // Compare username (case-insensitive)
                if (normalizeUsername(historicalResult.username) === normalizedUsername) {
                    return true;
                }
                
                // Compare business name if it's substantial enough
                if (normalizedBusinessName && normalizedBusinessName.length > 3 && 
                    normalizeBusinessName(historicalResult.businessName) === normalizedBusinessName) {
                    return true;
                }
                
                // Compare profile URL (case-insensitive)
                if (normalizeUrl(historicalResult.url) === normalizedUrl) {
                    return true;
                }
                
                return false;
            });
        }

        // Check if a result is likely valid based on the query context
        function isLikelyValidResult(result, nicheKeywords) {
            const username = result.username.toLowerCase();
            const businessName = (result.businessName || '').toLowerCase();
            const query = (result.query || '').toLowerCase();
            
            // Check if username or business name contains any niche keywords
            for (const keyword of nicheKeywords) {
                const keywordLower = keyword.toLowerCase();
                if (username.includes(keywordLower.replace(/\s+/g, '')) || 
                    businessName.includes(keywordLower)) {
                    return true;
                }
            }
            
            // Check if it's a generic or invalid account
            const invalidPatterns = ['instagram', 'explore', 'profile', 'business profile', 'page not found'];
            for (const pattern of invalidPatterns) {
                if (businessName.includes(pattern) && businessName.length < 20) {
                    return false;
                }
            }
            
            return true; // Default to valid if no clear indicators
        }

        // Deduplicate results by business name, keeping the most valid one
        function deduplicateResults(results, nicheKeywords) {
            const uniqueBusinesses = new Map(); // Key: normalized business name, Value: best result
            const seenUsernames = new Set(); // Track unique usernames
            
            results.forEach(result => {
                const normalizedName = normalizeBusinessName(result.businessName);
                const username = result.username.toLowerCase();
                
                // Skip if we've already seen this exact username
                if (seenUsernames.has(username)) {
                    return;
                }
                
                // Skip if business name is too generic or empty
                if (!normalizedName || normalizedName.length < 3) {
                    // But still add if username is unique
                    seenUsernames.add(username);
                    uniqueBusinesses.set(`username_${username}`, result);
                    return;
                }
                
                // Check if we already have a result for this business
                if (uniqueBusinesses.has(normalizedName)) {
                    const existing = uniqueBusinesses.get(normalizedName);
                    
                    // Determine which result is better
                    const currentIsValid = isLikelyValidResult(result, nicheKeywords);
                    const existingIsValid = isLikelyValidResult(existing, nicheKeywords);
                    
                    // Prefer the valid result
                    if (currentIsValid && !existingIsValid) {
                        uniqueBusinesses.set(normalizedName, result);
                        seenUsernames.delete(existing.username.toLowerCase());
                        seenUsernames.add(username);
                    } else if (!currentIsValid && existingIsValid) {
                        // Keep existing
                    } else {
                        // Both valid or both invalid - prefer the one with shorter username (usually more official)
                        if (username.length < existing.username.length) {
                            uniqueBusinesses.set(normalizedName, result);
                            seenUsernames.delete(existing.username.toLowerCase());
                            seenUsernames.add(username);
                        }
                    }
                } else {
                    // First time seeing this business name
                    uniqueBusinesses.set(normalizedName, result);
                    seenUsernames.add(username);
                }
            });
            
            // Return deduplicated results
            return Array.from(uniqueBusinesses.values());
        }

        // ========================================
        // HELPER FUNCTIONS
        // ========================================
        function getMaxResultsLimit() {
            const input = document.getElementById('maxResults');
            const value = parseInt(input.value);
            
            if (!value || value <= 0) {
                return null;
            }
            
            return value;
        }

        function updateLimitStatus() {
            const limitStatusText = document.getElementById('limitStatusText');
            const limitStatus = document.getElementById('limitStatus');
            const maxLimit = getMaxResultsLimit();
            
            if (maxLimit === null) {
                limitStatusText.textContent = 'No limit set (unlimited results)';
                limitStatus.className = 'px-3 py-2 bg-gray-50 border border-gray-200 rounded-md';
            } else {
                limitStatusText.textContent = `Maximum ${maxLimit} results per search`;
                limitStatus.className = 'px-3 py-2 bg-blue-50 border border-blue-200 rounded-md';
            }
            
            console.log(`Results limit: ${maxLimit === null ? 'Unlimited' : maxLimit}`);
        }

        function showInfoMessage(message, type = 'info') {
            const infoContainer = document.getElementById('infoMessage');
            const infoContent = document.getElementById('infoContent');
            const infoText = document.getElementById('infoText');
            
            infoText.textContent = message;
            
            if (type === 'warning') {
                infoContent.className = 'bg-yellow-50 border border-yellow-300 rounded-lg p-4';
                infoText.className = 'text-sm text-yellow-800';
            } else if (type === 'info') {
                infoContent.className = 'bg-blue-50 border border-blue-300 rounded-lg p-4';
                infoText.className = 'text-sm text-blue-800';
            } else if (type === 'success') {
                infoContent.className = 'bg-green-50 border border-green-300 rounded-lg p-4';
                infoText.className = 'text-sm text-green-800';
            }
            
            infoContainer.classList.remove('hidden');
            
            setTimeout(() => {
                infoContainer.classList.add('hidden');
            }, 7000);
        }

        function hideInfoMessage() {
            document.getElementById('infoMessage').classList.add('hidden');
        }

        // Extract business name from title or snippet
        function extractBusinessName(title, snippet) {
            // Clean up the title first - remove Instagram suffix
            let businessName = title || '';
            businessName = businessName.replace(/\s*KATEX_INLINE_OPEN@[^)]+KATEX_INLINE_CLOSE\s*•?\s*Instagram.*$/i, '');
            businessName = businessName.replace(/\s*-\s*Instagram.*$/i, '');
            businessName = businessName.replace(/\s*\|\s*Instagram.*$/i, '');
            businessName = businessName.replace(/\s*on\s*Instagram.*$/i, '');
            
            // If title is too generic or empty, try to extract from snippet
            if (!businessName || businessName.toLowerCase().includes('instagram')) {
                // Try to find business name in snippet
                const snippetMatch = snippet.match(/^([^.!?]+)/);
                if (snippetMatch) {
                    businessName = snippetMatch[1].trim();
                }
            }
            
            // Clean up any remaining Instagram references
            businessName = businessName.replace(/Instagram/gi, '').trim();
            
            // If still empty or too short, return a default
            if (!businessName || businessName.length < 2) {
                businessName = 'Business Profile';
            }
            
            return businessName;
        }

        function extractInstagramInfo(item) {
            const link = item.link || '';
            const snippet = item.snippet || '';
            const title = item.title || '';
            
            const instagramRegex = /(?:instagram\.com\/|@)([A-Za-z0-9_.]+)/gi;
            const results = [];
            
            // Extract all usernames from link, snippet, and title
            const usernamesFound = new Set();
            [link, snippet, title].forEach(text => {
                const matches = text.matchAll(instagramRegex);
                for (const match of matches) {
                    const username = match[1].toLowerCase();
                    if (username && !['p', 'explore', 'reel', 'tv', 'stories'].includes(username) && !usernamesFound.has(username)) {
                        usernamesFound.add(username);
                        
                        // Extract business name for this result
                        const businessName = extractBusinessName(title, snippet);
                        
                        results.push({
                            username: username,
                            businessName: businessName
                        });
                    }
                }
            });
            
            return results;
        }

        async function searchGoogle(query, apiKey, cx) {
            const url = `https://www.googleapis.com/customsearch/v1?key=${apiKey}&cx=${cx}&q=${encodeURIComponent(query + ' site:instagram.com')}`;
            
            console.log(`Searching: ${query}`);
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log(`Results for "${query}":`, data);
                return data.items || [];
            } catch (error) {
                console.error(`Error searching for "${query}":`, error);
                return [];
            }
        }

        // ========================================
        // MAIN SEARCH FUNCTION
        // ========================================
        async function performSearches(options = {}) {
            const apiKey = document.getElementById('apiKey').value.trim();
            const cx = document.getElementById('searchEngineId').value.trim();
            
            if (!apiKey || !cx) {
                alert('Please enter both API Key and Search Engine ID in Settings tab');
                switchTab('settings');
                return;
            }
            
            saveApiSettings();

            const nicheSetOverride = options.nicheSetOverride || null;
            const sessionLabel = options.sessionLabel || null;
            let effectiveSelectedNiches = nicheSetOverride || null;
            if (!effectiveSelectedNiches) {
                effectiveSelectedNiches = new Map();
                selectedNiches.forEach((val, key) => effectiveSelectedNiches.set(key, val));
                if (typeof selectedNanoNiches !== 'undefined' && selectedNanoNiches instanceof Map) {
                    selectedNanoNiches.forEach((val, key) => {
                        if (!effectiveSelectedNiches.has(key)) {
                            effectiveSelectedNiches.set(key, val);
                        }
                    });
                }
            }
            
            if (effectiveSelectedNiches.size === 0) {
                alert('Please select at least one niche');
                return;
            }
            
            const selectedLocations = getSelectedLocations();
            if (selectedLocations.length === 0) {
                alert('Please select at least one city');
                return;
            }
            
            hideInfoMessage();
            
            // CLEAR PREVIOUS RESULTS BEFORE NEW SEARCH
            currentSearchResults = [];
            
            const maxLimit = getMaxResultsLimit();
            console.log(`Starting search with limit: ${maxLimit === null ? 'Unlimited' : maxLimit}`);
            
            searchSessionCount++;
            const sessionStartTime = new Date();
            const sessionId = `session_${searchSessionCount}_${Date.now()}`;
            
            const sessionResults = [];
            const sessionUsernames = new Set();
            let limitReached = false;
            
            // Clear results display and show searching message
            document.getElementById('resultsContainer').innerHTML = '<p class="text-gray-500 text-center py-8">Searching...</p>';
            document.getElementById('resultCount').textContent = '';
            document.getElementById('exportCurrentBtn').classList.add('hidden');
            
            const queries = [];
            const nicheNames = [];
            const locationDisplayNames = [];
            const allNicheKeywords = [];
            
            effectiveSelectedNiches.forEach((niche, nicheKey) => {
                nicheNames.push(niche.name);
                allNicheKeywords.push(...niche.variations);
                niche.variations.forEach(variation => {
                    selectedLocations.forEach(location => {
                        const cityName = location.city;
                        queries.push(`${variation} ${cityName}`);
                    });
                });
            });
            
            // Create location display names with city and state
            selectedLocations.forEach(loc => {
                if (loc.state) {
                    locationDisplayNames.push(`${loc.city} (${loc.state})`);
                } else {
                    locationDisplayNames.push(loc.city);
                }
            });
            
            console.log(`Search Session #${searchSessionCount} - Total queries: ${queries.length}`);
            console.log(`Using niches: ${nicheNames.join(', ')}`);
            console.log(`Using cities: ${locationDisplayNames.slice(0, 5).join(', ')}${locationDisplayNames.length > 5 ? '...' : ''}`);
            
            // Collect all results first
            const allSessionResults = [];
            
            // Get all historical results to check for duplicates
            const allHistoricalResults = getAllHistoricalResults();
            console.log(`Found ${allHistoricalResults.length} historical results to check for duplicates`);
            
            let duplicatesSkipped = 0;
            
            for (const query of queries) {
                if (maxLimit !== null && allSessionResults.length >= maxLimit * 2) {
                    // Collect more than limit to allow for deduplication
                    console.log(`Collected enough results for deduplication.`);
                    break;
                }
                
                const items = await searchGoogle(query, apiKey, cx);
                
                for (const item of items) {
                    const extractedInfo = extractInstagramInfo(item);
                    
                    for (const info of extractedInfo) {
                        // Skip if we've already seen this username in the current session
                        if (sessionUsernames.has(info.username)) {
                            continue;
                        }
                        
                        // Create the result object
                        const result = {
                            username: info.username,
                            businessName: info.businessName,
                            url: `https://instagram.com/${info.username}`,
                            query: query
                        };
                        
                        // Skip if this result already exists in history
                        if (isResultInHistory(result, allHistoricalResults)) {
                            duplicatesSkipped++;
                            continue;
                        }
                        
                        // Add to current session results
                        sessionUsernames.add(info.username);
                        allSessionResults.push(result);
                    }
                }
                
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            // Deduplicate results within the current session
            console.log(`Before deduplication: ${allSessionResults.length} results (${duplicatesSkipped} historical duplicates skipped)`);
            const deduplicatedResults = deduplicateResults(allSessionResults, allNicheKeywords);
            console.log(`After deduplication: ${deduplicatedResults.length} results`);
            
            // Apply limit after deduplication
            let finalResults = deduplicatedResults;
            if (maxLimit !== null && deduplicatedResults.length > maxLimit) {
                finalResults = deduplicatedResults.slice(0, maxLimit);
                limitReached = true;
            }
            
            // Store current search results
            currentSearchResults = [...finalResults];
            
            // Create display name with niche and locations with states
            const sessionDisplayName = `${sessionLabel ? sessionLabel + ' – ' : ''}${nicheNames.join(' + ')} – ${locationDisplayNames.slice(0, 3).join(', ')}${locationDisplayNames.length > 3 ? '...' : ''}`;
            const historyEntry = {
                sessionId: sessionId,
                sessionNumber: searchSessionCount,
                timestamp: sessionStartTime.toISOString(),
                displayName: sessionDisplayName,
                niches: nicheNames,
                locations: selectedLocations,
                locationDisplayNames: locationDisplayNames,
                queries: queries.length,
                foundResults: finalResults.length,
                limitApplied: maxLimit,
                limitReached: limitReached,
                results: [...finalResults]
            };
            
            searchHistoryWithResults.push(historyEntry);
            saveToLocalStorage();
            
            if (limitReached) {
                showInfoMessage(
                    `Maximum of ${maxLimit} unique results reached after deduplication.`,
                    'info'
                );
            } else if (finalResults.length === 0) {
                showInfoMessage('No Instagram usernames found in this search.', 'warning');
            } else {
                const removedCount = allSessionResults.length - deduplicatedResults.length;
                showInfoMessage(
                    `Successfully collected ${finalResults.length} unique results (${removedCount} duplicates removed).`,
                    'success'
                );
            }
            
            console.log(`Session #${searchSessionCount} complete - Found ${finalResults.length} unique results`);
            
            updateCurrentResultsDisplay();
            updateSearchHistory();
        }

        // Update display for current search results only
        function updateCurrentResultsDisplay(recalledSession = null) {
            const container = document.getElementById('resultsContainer');
            const resultCount = document.getElementById('resultCount');
            const exportBtn = document.getElementById('exportCurrentBtn');
            
            if (currentSearchResults.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No Instagram usernames found.</p>';
                resultCount.textContent = '';
                exportBtn.classList.add('hidden');
                return;
            }
            
            const uniqueUsernames = new Set(currentSearchResults.map(r => r.username));
            
            if (recalledSession) {
                resultCount.textContent = `Recalled: ${currentSearchResults.length} unique businesses`;
            } else {
                resultCount.textContent = `Found: ${currentSearchResults.length} unique businesses`;
            }
            
            exportBtn.classList.remove('hidden');
            
            let html = '<div class="grid gap-2">';
            
            if (recalledSession) {
                html += `<div class="bg-blue-50 border border-blue-200 rounded p-3 mb-2">
                            <span class="text-sm text-blue-800">📋 Recalled from: ${recalledSession.displayName} (Session #${recalledSession.sessionNumber})</span>
                         </div>`;
            }
            
            currentSearchResults.forEach((data, index) => {
                const businessName = data.businessName || 'Business Name Not Available';
                const query = data.query || 'N/A'; // Safety check for missing query
                const resultNumber = index + 1; // Add numbering starting from 1
                html += `
                    <div class="border border-gray-200 rounded p-3 hover:bg-gray-50">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="font-bold text-gray-900"><span class="inline-block bg-gray-100 text-gray-800 rounded-full px-2 mr-2 text-sm">#${resultNumber}</span>${businessName}</div>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-gray-700">@${data.username}</span>
                                    <a href="${data.url}" target="_blank" class="text-blue-600 hover:underline text-sm">
                                        View Profile →
                                    </a>
                                </div>
                            </div>
                            <div class="text-xs text-gray-500 text-right">
                                ${query}
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function updateSearchHistory() {
            const historyContainer = document.getElementById('searchHistory');
            const clearHistoryBtn = document.getElementById('clearHistoryBtn');
            const exportAllBtn = document.getElementById('exportAllBtn');
            
            if (searchHistoryWithResults.length === 0) {
                historyContainer.innerHTML = '<p class="text-gray-500">No searches performed yet.</p>';
                clearHistoryBtn.classList.add('hidden');
                exportAllBtn.classList.add('hidden');
                return;
            }
            
            clearHistoryBtn.classList.remove('hidden');
            exportAllBtn.classList.remove('hidden');
            
            let html = '<div class="space-y-2">';
            searchHistoryWithResults.slice().reverse().forEach(session => {
                const date = new Date(session.timestamp);
                const limitInfo = session.limitApplied ? 
                    `<span class="text-xs ${session.limitReached ? 'text-orange-600' : 'text-green-600'}">
                        (Limit: ${session.limitApplied}${session.limitReached ? ' - Reached' : ''})
                    </span>` : 
                    '<span class="text-xs text-gray-600">(No limit)</span>';
                
                html += `
                    <div class="border-l-4 ${session.limitReached ? 'border-orange-500' : 'border-blue-500'} pl-3 py-2 hover:bg-gray-50 cursor-pointer group"
                         onclick="recallSearchSession('${session.sessionId}')">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="font-medium">
                                    Session #${session.sessionNumber} ${limitInfo}
                                    <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded ml-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                        Click to recall
                                    </span>
                                </div>
                                <div class="text-xs text-gray-600">
                                    ${date.toLocaleString()} • ${session.queries} queries • 
                                    Found ${session.foundResults} unique results
                                </div>
                                <div class="text-sm text-blue-600 font-medium mt-1">
                                    ${session.displayName}
                                </div>
                                <div class="text-xs text-gray-500 mt-1">
                                    Locations: ${session.locationDisplayNames ? session.locationDisplayNames.slice(0, 5).join(', ') : 'N/A'}${session.locationDisplayNames && session.locationDisplayNames.length > 5 ? '...' : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            historyContainer.innerHTML = html;
        }

        function exportCurrentToCSV() {
            if (currentSearchResults.length === 0) return;
            
            let csv = 'Business Name,Username,Profile URL,Search Query\n';
            currentSearchResults.forEach((data) => {
                const businessName = data.businessName || 'N/A';
                csv += `"${businessName}","${data.username}","${data.url}","${data.query || 'N/A'}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `instagram_current_results_${Date.now()}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            console.log(`Exported ${currentSearchResults.length} current results to CSV`);
        }

        function exportAllToCSV() {
            let allResults = [];
            searchHistoryWithResults.forEach(session => {
                session.results.forEach(result => {
                    allResults.push({
                        ...result,
                        sessionNumber: session.sessionNumber,
                        sessionDate: session.timestamp
                    });
                });
            });
            
            if (allResults.length === 0) {
                alert('No results to export');
                return;
            }
            
            let csv = 'Session Number,Session Date,Business Name,Username,Profile URL,Search Query\n';
            allResults.forEach((data) => {
                const businessName = data.businessName || 'N/A';
                const sessionDate = new Date(data.sessionDate).toLocaleString();
                csv += `"${data.sessionNumber}","${sessionDate}","${businessName}","${data.username}","${data.url}","${data.query || 'N/A'}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `instagram_all_history_${Date.now()}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            console.log(`Exported ${allResults.length} total results to CSV`);
        }

        function handleClearHistory() {
            if (confirm('Are you sure you want to clear all search history?')) {
                searchHistoryWithResults = [];
                searchSessionCount = 0;
                currentSearchResults = [];
                saveToLocalStorage();
                updateSearchHistory();
                updateCurrentResultsDisplay();
                updateSettingsStats();
                showInfoMessage('Search history cleared.', 'info');
            }
        }

        // ========================================
        // EVENT LISTENERS
        // ========================================
        // Event delegation for dynamic niche buttons
        document.getElementById('niche-selection').addEventListener('click', function(e) {
            if (e.target.classList.contains('niche-btn')) {
                const nicheKey = e.target.dataset.niche;
                toggleNiche(nicheKey);
            }
        });

        // Event delegation for Nano Banana niche buttons
        const nanoSectionEl = document.getElementById('nano-niche-selection');
        if (nanoSectionEl) {
            nanoSectionEl.addEventListener('click', function(e) {
                if (e.target.classList.contains('nano-niche-btn')) {
                    const nicheKey = e.target.dataset.nanoNiche;
                    toggleNanoNiche(nicheKey);
                }
            });
            const toggleBtn = document.getElementById('nanoToggleBtn');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', () => {
                    const content = document.getElementById('nanoNicheContent');
                    if (!content) return;
                    const hiddenNow = content.classList.toggle('hidden');
                    toggleBtn.textContent = hiddenNow ? 'Show' : 'Hide';
                });
            }
        }

        document.getElementById('apiKey').addEventListener('blur', saveApiSettings);
        document.getElementById('searchEngineId').addEventListener('blur', saveApiSettings);
        const placesApiKeyEl = document.getElementById('placesApiKey');
        if (placesApiKeyEl) {
            placesApiKeyEl.addEventListener('blur', saveApiSettings);
        }

        document.getElementById('searchBtn').addEventListener('click', performSearches);
        const placesSearchBtnEl = document.getElementById('placesSearchBtn');
        if (placesSearchBtnEl) {
            placesSearchBtnEl.addEventListener('click', performPlacesSearches);
        }
        document.getElementById('exportCurrentBtn').addEventListener('click', exportCurrentToCSV);
        const placesExportCurrentBtnEl = document.getElementById('placesExportCurrentBtn');
        if (placesExportCurrentBtnEl) {
            placesExportCurrentBtnEl.addEventListener('click', exportPlacesCurrentToCSV);
        }
        document.getElementById('exportAllBtn').addEventListener('click', exportAllToCSV);
        document.getElementById('clearHistoryBtn').addEventListener('click', handleClearHistory);
        document.getElementById('clearAllDataBtn').addEventListener('click', clearAllSavedData);
        document.getElementById('maxResults').addEventListener('input', updateLimitStatus);
        const placesMaxResultsEl = document.getElementById('placesMaxResults');
        if (placesMaxResultsEl) {
            placesMaxResultsEl.addEventListener('input', updatePlacesLimitStatus);
        }
        document.getElementById('selectAllCitiesBtn').addEventListener('click', selectAllCities);
        document.getElementById('deselectAllCitiesBtn').addEventListener('click', deselectAllCities);
        const selectAllPlacesCitiesBtnEl = document.getElementById('selectAllPlacesCitiesBtn');
        const deselectAllPlacesCitiesBtnEl = document.getElementById('deselectAllPlacesCitiesBtn');
        if (selectAllPlacesCitiesBtnEl) {
            selectAllPlacesCitiesBtnEl.addEventListener('click', selectAllPlacesCities);
        }
        if (deselectAllPlacesCitiesBtnEl) {
            deselectAllPlacesCitiesBtnEl.addEventListener('click', deselectAllPlacesCities);
        }

        // Make functions globally accessible
        window.recallSearchSession = recallSearchSession;
        window.toggleCountry = toggleCountry;
        window.toggleCity = toggleCity;
        window.selectAllInCountry = selectAllInCountry;
        window.deselectAllInCountry = deselectAllInCountry;
        window.togglePlacesCountry = togglePlacesCountry;
        window.togglePlacesCity = togglePlacesCity;
        window.selectAllPlacesInCountry = selectAllPlacesInCountry;
        window.deselectAllPlacesInCountry = deselectAllPlacesInCountry;
        window.switchTab = switchTab;

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            loadFromLocalStorage();
            initializeCountriesAndCities();
            initializeNiches();
            initializeNanoBananaNiches();
            initializePlacesCountriesAndCities();
            initializePlacesNiches();
            updateCurrentResultsDisplay();
            updateSearchHistory();
            updateLimitStatus();
            updatePlacesLimitStatus();
            updateSelectedNichesDisplay();
            updateSelectedNanoNichesDisplay();
            updateSelectedPlacesNichesDisplay();
            updateSelectedCitiesCount();
            updateSelectedPlacesCitiesCount();
        });
        // Event delegation for Places niche buttons
        document.getElementById('places-niche-selection').addEventListener('click', function(e) {
            if (e.target.classList.contains('places-niche-btn')) {
                const nicheKey = e.target.dataset.placeNiche;
                togglePlacesNiche(nicheKey);
            }
        });
        
        // ========================================
        // GOOGLE PLACES – STATE, UI, AND SEARCH LOGIC
        // ========================================
        let selectedNichesPlaces = new Map();
        let selectedCitiesPlaces = new Map();
        let placesCurrentResults = [];
        const cityLatLngCache = new Map();

        function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

        function updatePlacesLimitStatus() {
            const input = document.getElementById('placesMaxResults');
            const textEl = document.getElementById('placesLimitStatusText');
            if (!input || !textEl) return;
            const val = input.value.trim();
            if (val === '' || isNaN(parseInt(val)) || parseInt(val) <= 0) {
                textEl.textContent = 'Default limit (20 results per query)';
            } else {
                textEl.textContent = `Limit set to ${parseInt(val)} results per query`;
            }
        }

        function getPlacesMaxResultsLimit() {
            const input = document.getElementById('placesMaxResults');
            if (!input) return 20;
            const val = input.value.trim();
            if (val === '' || isNaN(parseInt(val)) || parseInt(val) <= 0) return 20;
            return parseInt(val);
        }

        function showPlacesInfoMessage(message, type = 'info') {
            const infoContainer = document.getElementById('placesInfoMessage');
            const infoContent = document.getElementById('placesInfoContent');
            const infoText = document.getElementById('placesInfoText');
            if (!infoContainer || !infoContent || !infoText) return;
            infoText.textContent = message;
            if (type === 'warning') {
                infoContent.className = 'bg-yellow-50 border border-yellow-300 rounded-lg p-4';
                infoText.className = 'text-sm text-yellow-800';
            } else if (type === 'success') {
                infoContent.className = 'bg-green-50 border border-green-300 rounded-lg p-4';
                infoText.className = 'text-sm text-green-800';
            } else {
                infoContent.className = 'bg-blue-50 border border-blue-300 rounded-lg p-4';
                infoText.className = 'text-sm text-blue-800';
            }
            infoContainer.classList.remove('hidden');
            setTimeout(() => infoContainer.classList.add('hidden'), 7000);
        }

        // Resolve Places API key from multiple sources to support local and deployed environments
        function getPlacesApiKey() {
            const fromInput = (document.getElementById('placesApiKey')?.value || '').trim();
            const fromWindow = (window.__ENV && window.__ENV.PLACES_API_KEY) ? String(window.__ENV.PLACES_API_KEY).trim() : '';
            const fromMeta = (document.querySelector('meta[name="places-api-key"]')?.content || '').trim();
            const fromQuery = new URLSearchParams(window.location.search).get('PLACES_API_KEY') || '';
            return fromInput || fromWindow || fromMeta || fromQuery;
        }

        function initializePlacesNiches() {
            const container = document.querySelector('.places-niche-buttons');
            if (!container) return;
            let html = '';
            Object.entries(niches).forEach(([key, niche]) => {
                html += `
                    <button id="places-${key}Btn" data-place-niche="${key}" class="places-niche-btn bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition duration-200 text-sm">
                        ${niche.name}
                    </button>
                `;
            });
            container.innerHTML = html;
        }

        function updateSelectedPlacesNichesDisplay() {
            const listEl = document.getElementById('selectedPlacesNichesList');
            if (!listEl) return;
            if (selectedNichesPlaces.size === 0) {
                listEl.textContent = 'None';
                return;
            }
            const names = Array.from(selectedNichesPlaces.values()).map(n => n.name);
            listEl.textContent = names.join(', ');
        }

        function togglePlacesNiche(nicheKey) {
            const niche = niches[nicheKey];
            if (!niche) return;
            const button = document.querySelector(`[data-place-niche="${nicheKey}"]`);
            if (selectedNichesPlaces.has(nicheKey)) {
                selectedNichesPlaces.delete(nicheKey);
                if (button) { button.classList.remove('bg-blue-600', 'ring-2', 'ring-blue-400'); button.classList.add('bg-gray-600'); }
            } else {
                selectedNichesPlaces.set(nicheKey, niche);
                if (button) { button.classList.remove('bg-gray-600'); button.classList.add('bg-blue-600', 'ring-2', 'ring-blue-400'); }
            }
            updateSelectedPlacesNichesDisplay();
        }

        function initializePlacesCountriesAndCities() {
            const container = document.getElementById('placesCountriesContainer');
            if (!container) return;
            let html = '';
            Object.keys(countriesAndCities).forEach((country, index) => {
                const cities = countriesAndCities[country];
                const countryId = `places-country-${index}`;
                const cityCount = typeof cities === 'object' ? Object.keys(cities).length : cities.length;
                html += `
                    <div class="border border-gray-200 rounded-lg overflow-hidden">
                        <div class="bg-gray-100 px-4 py-2 cursor-pointer hover:bg-gray-200 transition-colors flex justify-between items-center"
                             onclick="togglePlacesCountry('${countryId}')">
                            <div class="flex items-center gap-2">
                                <span id="${countryId}-arrow" class="text-gray-500 transition-transform">▶</span>
                                <span class="font-medium">${country}</span>
                                <span class="text-xs text-gray-500">(${cityCount} cities)</span>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="event.stopPropagation(); selectAllPlacesInCountry('${country}')" 
                                        class="text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">
                                    Select All
                                </button>
                                <button onclick="event.stopPropagation(); deselectAllPlacesInCountry('${country}')" 
                                        class="text-xs bg-gray-500 text-white px-2 py-1 rounded hover:bg-gray-600">
                                    Deselect All
                                </button>
                            </div>
                        </div>
                        <div id="${countryId}-cities" class="hidden px-4 py-2 bg-white">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                `;
                if (typeof cities === 'object') {
                    Object.entries(cities).forEach(([city, state], cityIndex) => {
                        const cityId = `${countryId}-city-${cityIndex}`;
                        const cityWithState = `${city} (${state})`;
                        html += `
                            <label class="flex items-center text-sm cursor-pointer hover:bg-gray-50 p-1 rounded">
                                <input type="checkbox" id="${cityId}" value="${city}" 
                                       data-state="${state}"
                                       data-country="${country}"
                                       onchange="togglePlacesCity('${city}', '${state}', '${country}')"
                                       class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <span>${cityWithState}</span>
                            </label>
                        `;
                    });
                } else {
                    cities.forEach((city, cityIndex) => {
                        const cityId = `${countryId}-city-${cityIndex}`;
                        html += `
                            <label class="flex items-center text-sm cursor-pointer hover:bg-gray-50 p-1 rounded">
                                <input type="checkbox" id="${cityId}" value="${city}" 
                                       data-country="${country}"
                                       onchange="togglePlacesCity('${city}', '', '${country}')"
                                       class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <span>${city}</span>
                            </label>
                        `;
                    });
                }
                html += `
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function togglePlacesCountry(countryId) {
            const citiesDiv = document.getElementById(`${countryId}-cities`);
            const arrow = document.getElementById(`${countryId}-arrow`);
            if (citiesDiv.classList.contains('hidden')) {
                citiesDiv.classList.remove('hidden');
                arrow.style.transform = 'rotate(90deg)';
            } else {
                citiesDiv.classList.add('hidden');
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        function togglePlacesCity(city, state, country) {
            const key = state ? `${city}, ${state}` : city;
            if (selectedCitiesPlaces.has(key)) {
                selectedCitiesPlaces.delete(key);
            } else {
                selectedCitiesPlaces.set(key, {city, state, country});
            }
            updateSelectedPlacesCitiesCount();
        }

        function selectAllPlacesInCountry(country) {
            const cities = countriesAndCities[country];
            if (typeof cities === 'object') {
                Object.entries(cities).forEach(([city, state]) => {
                    const key = `${city}, ${state}`;
                    selectedCitiesPlaces.set(key, {city, state, country});
                    const checkbox = document.querySelector(`#placesCountriesContainer input[value="${city}"][data-state="${state}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            } else {
                cities.forEach(city => {
                    selectedCitiesPlaces.set(city, {city, state: '', country});
                    const checkbox = document.querySelector(`#placesCountriesContainer input[value="${city}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            updateSelectedPlacesCitiesCount();
        }

        function deselectAllPlacesInCountry(country) {
            const cities = countriesAndCities[country];
            if (typeof cities === 'object') {
                Object.entries(cities).forEach(([city, state]) => {
                    const key = `${city}, ${state}`;
                    selectedCitiesPlaces.delete(key);
                    const checkbox = document.querySelector(`#placesCountriesContainer input[value="${city}"][data-state="${state}"]`);
                    if (checkbox) checkbox.checked = false;
                });
            } else {
                cities.forEach(city => {
                    selectedCitiesPlaces.delete(city);
                    const checkbox = document.querySelector(`#placesCountriesContainer input[value="${city}"]`);
                    if (checkbox) checkbox.checked = false;
                });
            }
            updateSelectedPlacesCitiesCount();
        }

        function selectAllPlacesCities() {
            Object.entries(countriesAndCities).forEach(([country, cities]) => {
                if (typeof cities === 'object') {
                    Object.entries(cities).forEach(([city, state]) => {
                        const key = `${city}, ${state}`;
                        selectedCitiesPlaces.set(key, {city, state, country});
                        const checkbox = document.querySelector(`#placesCountriesContainer input[value="${city}"][data-state="${state}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                } else {
                    cities.forEach(city => {
                        selectedCitiesPlaces.set(city, {city, state: '', country});
                        const checkbox = document.querySelector(`#placesCountriesContainer input[value="${city}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
            });
            updateSelectedPlacesCitiesCount();
        }

        function deselectAllPlacesCities() {
            selectedCitiesPlaces.clear();
            document.querySelectorAll('#placesCountriesContainer input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateSelectedPlacesCitiesCount();
        }

        function updateSelectedPlacesCitiesCount() {
            const el = document.getElementById('selectedPlacesCitiesCount');
            if (el) el.textContent = selectedCitiesPlaces.size;
        }

        function getSelectedPlacesLocations() {
            return Array.from(selectedCitiesPlaces.values());
        }

        async function resolveCityLatLng(city, state, country, apiKey) {
            const keyStr = `${city}|${state}|${country}`;
            if (cityLatLngCache.has(keyStr)) return cityLatLngCache.get(keyStr);
            const query = `${city}${state ? ', ' + state : ''}, ${country}`;
            const url = `https://maps.googleapis.com/maps/api/place/textsearch/json?query=${encodeURIComponent(query)}&key=${apiKey}`;
            try {
                const resp = await fetch(url);
                if (!resp.ok) throw new Error(`Text Search failed: ${resp.status}`);
                const data = await resp.json();
                const first = (data.results || [])[0];
                if (first && first.geometry && first.geometry.location) {
                    const loc = first.geometry.location;
                    cityLatLngCache.set(keyStr, loc);
                    return loc;
                }
                return null;
            } catch (e) {
                console.error('resolveCityLatLng error', e);
                return null;
            }
        }

        async function nearbySearchPlaces(location, keyword, apiKey, radiusMeters = 30000, pagetoken = null) {
            const params = new URLSearchParams({
                location: `${location.lat},${location.lng}`,
                radius: String(radiusMeters),
                keyword,
                key: apiKey
            });
            if (pagetoken) params.set('pagetoken', pagetoken);
            const url = `https://maps.googleapis.com/maps/api/place/nearbysearch/json?${params.toString()}`;
            try {
                const resp = await fetch(url);
                if (!resp.ok) throw new Error(`Nearby Search failed: ${resp.status}`);
                const data = await resp.json();
                return {
                    status: data.status,
                    results: data.results || [],
                    nextPageToken: data.next_page_token || null
                };
            } catch (e) {
                console.error('nearbySearchPlaces error', e);
                return { status: 'ERROR', results: [], nextPageToken: null };
            }
        }

        async function placeDetails(placeId, apiKey) {
            const fields = 'name,formatted_address,formatted_phone_number,international_phone_number,website,url,rating,types';
            const url = `https://maps.googleapis.com/maps/api/place/details/json?place_id=${placeId}&fields=${fields}&key=${apiKey}`;
            try {
                const resp = await fetch(url);
                if (!resp.ok) throw new Error(`Place Details failed: ${resp.status}`);
                const data = await resp.json();
                return { status: data.status, result: data.result || {} };
            } catch (e) {
                console.error('placeDetails error', e);
                return { status: 'ERROR', result: {} };
            }
        }

        async function performPlacesSearches() {
            const placesApiKey = getPlacesApiKey();
            if (!placesApiKey) {
                alert('Please enter your Google Places API Key in Settings tab');
                switchTab('settings');
                return;
            }
            saveApiSettings();

            if (selectedNichesPlaces.size === 0) {
                alert('Please select at least one niche');
                return;
            }
            const selectedLocations = getSelectedPlacesLocations();
            if (selectedLocations.length === 0) {
                alert('Please select at least one city');
                return;
            }

            const searchBtn = document.getElementById('placesSearchBtn');
            if (searchBtn) { searchBtn.disabled = true; searchBtn.textContent = 'Searching…'; }
            placesCurrentResults = [];
            document.getElementById('placesResultsContainer').innerHTML = '<p class="text-gray-500 text-center py-8">Searching...</p>';
            document.getElementById('placesResultCount').textContent = '';
            document.getElementById('placesExportCurrentBtn').classList.add('hidden');

            const perQueryLimit = getPlacesMaxResultsLimit();
            const queries = [];

            selectedNichesPlaces.forEach((niche) => {
                niche.variations.forEach(variation => {
                    selectedLocations.forEach(loc => {
                        queries.push({ variation, loc, nicheName: niche.name });
                    });
                });
            });

            showPlacesInfoMessage(`Running ${queries.length} searches…`, 'info');

            const seenPlaceIds = new Set();
            let totalFetched = 0, totalSkippedHasWebsite = 0, totalDetailsErrors = 0, totalDenied = 0;
            for (const q of queries) {
                const { variation, loc } = q;
                const cityCenter = await resolveCityLatLng(loc.city, loc.state, loc.country, placesApiKey);
                if (!cityCenter) {
                    console.warn('Could not resolve location for', loc);
                    continue;
                }
                let nextToken = null;
                let countForQuery = 0;
                for (let page = 0; page < 3; page++) {
                    const nearby = await nearbySearchPlaces(cityCenter, variation, placesApiKey, 30000, nextToken);
                    if (nearby.status === 'REQUEST_DENIED' || nearby.status === 'INVALID_REQUEST') { totalDenied++; break; }
                    const nearbyResults = nearby.results;
                    totalFetched += nearbyResults.length;
                    for (const r of nearbyResults) {
                        if (perQueryLimit && countForQuery >= perQueryLimit) break;
                        if (!r.place_id || seenPlaceIds.has(r.place_id)) continue;
                        const det = await placeDetails(r.place_id, placesApiKey);
                        await sleep(300);
                        if (det.status !== 'OK') {
                            totalDetailsErrors++;
                            // Include minimal record when details are denied or error, so users see candidates
                            // Note: website is unknown in this case
                            seenPlaceIds.add(r.place_id);
                            placesCurrentResults.push({
                                name: r.name || 'Unknown',
                                address: r.vicinity || 'N/A',
                                phone: 'N/A',
                                mapsUrl: `https://www.google.com/maps/search/?api=1&query=place_id:${r.place_id}`,
                                rating: typeof r.rating !== 'undefined' ? r.rating : 'N/A',
                                place_id: r.place_id,
                                query: `${variation} ${loc.city}`,
                                city: loc.city,
                                state: loc.state || '',
                                country: loc.country,
                                category: (r.types && r.types[0]) || q.nicheName,
                                niche: q.nicheName,
                                websiteStatus: 'unknown'
                            });
                            countForQuery++;
                            updatePlacesResultsDisplay();
                            continue;
                        }
                        const info = det.result || {};
                        const site = (info.website || '').trim();
                        const isRealWebsite = site && !/business\.site|g\.page|google\./i.test(site);
                        if (isRealWebsite) { totalSkippedHasWebsite++; continue; }
                        seenPlaceIds.add(r.place_id);
                        placesCurrentResults.push({
                            name: info.name || r.name || 'Unknown',
                            address: info.formatted_address || r.vicinity || 'N/A',
                            phone: info.formatted_phone_number || info.international_phone_number || 'N/A',
                            mapsUrl: info.url || `https://www.google.com/maps/search/?api=1&query=place_id:${r.place_id}`,
                            rating: typeof info.rating !== 'undefined' ? info.rating : 'N/A',
                            place_id: r.place_id,
                            query: `${variation} ${loc.city}`,
                            city: loc.city,
                            state: loc.state || '',
                            country: loc.country,
                            category: (info.types && info.types[0]) || (r.types && r.types[0]) || q.nicheName,
                            niche: q.nicheName,
                            websiteStatus: 'none'
                        });
                        countForQuery++;
                        updatePlacesResultsDisplay();
                    }
                    if (perQueryLimit && countForQuery >= perQueryLimit) break;
                    nextToken = nearby.nextPageToken;
                    if (!nextToken) break;
                    await sleep(2000);
                }
                if (countForQuery === 0) {
                    const textUrl = `https://maps.googleapis.com/maps/api/place/textsearch/json?query=${encodeURIComponent(variation + ' ' + loc.city + (loc.state ? ' ' + loc.state : '') + ' ' + (loc.country || ''))}&key=${placesApiKey}`;
                    try {
                        const resp = await fetch(textUrl);
                        if (resp.ok) {
                            const data = await resp.json();
                            const textResults = data.results || [];
                            totalFetched += textResults.length;
                            for (const r of textResults) {
                                if (perQueryLimit && countForQuery >= perQueryLimit) break;
                                if (!r.place_id || seenPlaceIds.has(r.place_id)) continue;
                                const det = await placeDetails(r.place_id, placesApiKey);
                                await sleep(300);
                                if (det.status !== 'OK') {
                                    totalDetailsErrors++;
                                    // Include minimal record when details are denied or error, so users see candidates
                                    seenPlaceIds.add(r.place_id);
                                    placesCurrentResults.push({
                                        name: r.name || 'Unknown',
                                        address: r.formatted_address || 'N/A',
                                        phone: 'N/A',
                                        mapsUrl: `https://www.google.com/maps/search/?api=1&query=place_id:${r.place_id}`,
                                        rating: typeof r.rating !== 'undefined' ? r.rating : 'N/A',
                                        place_id: r.place_id,
                                        query: `${variation} ${loc.city}`,
                                        city: loc.city,
                                        state: loc.state || '',
                                        country: loc.country,
                                        category: (r.types && r.types[0]) || q.nicheName,
                                        niche: q.nicheName,
                                        websiteStatus: 'unknown'
                                    });
                                    countForQuery++;
                                    updatePlacesResultsDisplay();
                                    continue;
                                }
                                const info = det.result || {};
                                const site = (info.website || '').trim();
                                const isRealWebsite = site && !/business\.site|g\.page|google\./i.test(site);
                                if (isRealWebsite) { totalSkippedHasWebsite++; continue; }
                                seenPlaceIds.add(r.place_id);
                                placesCurrentResults.push({
                                    name: info.name || r.name || 'Unknown',
                                    address: info.formatted_address || r.formatted_address || 'N/A',
                                    phone: info.formatted_phone_number || info.international_phone_number || 'N/A',
                                    mapsUrl: info.url || `https://www.google.com/maps/search/?api=1&query=place_id:${r.place_id}`,
                                    rating: typeof info.rating !== 'undefined' ? info.rating : 'N/A',
                                    place_id: r.place_id,
                                    query: `${variation} ${loc.city}`,
                                    city: loc.city,
                                    state: loc.state || '',
                                    country: loc.country,
                                    category: (info.types && info.types[0]) || (r.types && r.types[0]) || q.nicheName,
                                    niche: q.nicheName,
                                    websiteStatus: 'none'
                                });
                                countForQuery++;
                                updatePlacesResultsDisplay();
                            }
                        }
                    } catch (e) {
                        console.error('Text Search fallback error', e);
                    }
                }
                await sleep(350);
            }

            if (placesCurrentResults.length === 0) {
                const tipBase = ' Ensure Places API and Place Details are enabled, and the key allows requests from your current origin (localhost).';
                const tipDenied = totalDenied > 0 ? ' Requests were denied.' : '';
                showPlacesInfoMessage(`No businesses without websites found. Fetched: ${totalFetched}, Skipped (has website): ${totalSkippedHasWebsite}, Details errors: ${totalDetailsErrors}.${tipDenied}${tipBase}`, 'warning');
            } else {
                showPlacesInfoMessage(`Found ${placesCurrentResults.length} places without websites. Fetched: ${totalFetched}, Skipped: ${totalSkippedHasWebsite}, Details errors: ${totalDetailsErrors}.`, 'success');
            }
            updatePlacesResultsDisplay();
            if (searchBtn) { searchBtn.disabled = false; searchBtn.textContent = 'Search Google Places – No Website'; }
        }

        function updatePlacesResultsDisplay() {
            const container = document.getElementById('placesResultsContainer');
            const resultCount = document.getElementById('placesResultCount');
            const exportBtn = document.getElementById('placesExportCurrentBtn');
            if (!container || !resultCount || !exportBtn) return;
            if (placesCurrentResults.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No results found.</p>';
                resultCount.textContent = '';
                exportBtn.classList.add('hidden');
                return;
            }
            resultCount.textContent = `${placesCurrentResults.length} places without websites`;
            exportBtn.classList.remove('hidden');
            let html = '<div class="space-y-2">';
            placesCurrentResults.forEach((p) => {
                html += `
                    <div class="border border-gray-200 rounded-lg p-3">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-medium text-gray-800">${p.name}</div>
                                <div class="text-sm text-gray-600">${p.address}</div>
                                <div class="text-sm text-gray-600">${p.phone}</div>
                                <div class="text-sm text-gray-600">Rating: ${p.rating}</div>
                                <div class="text-sm text-gray-600">Category: ${p.category || 'N/A'}</div>
                                <div class="text-xs text-gray-500">Niche: ${p.niche || 'N/A'}</div>
                                <div class="text-xs ${p.websiteStatus === 'none' ? 'text-green-700' : 'text-gray-700'}">Website: ${p.websiteStatus === 'none' ? 'None' : 'Unknown'}</div>
                            </div>
                            <div class="text-right">
                                <a href="${p.mapsUrl}" target="_blank" class="text-blue-600 hover:underline text-sm">Open in Google Maps →</a>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 text-right">${p.query} • ${p.city}${p.state ? ', ' + p.state : ''}</div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function exportPlacesCurrentToCSV() {
            if (!placesCurrentResults.length) {
                alert('No results to export');
                return;
            }
            let csv = 'Business Name,Address,Phone,Google Maps URL,Rating,Query,City,State,Country\n';
            placesCurrentResults.forEach((p) => {
                csv += `"${p.name}","${p.address}","${p.phone}","${p.mapsUrl}","${p.rating}","${p.query}","${p.city}","${p.state}","${p.country}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `google_places_no_website_${Date.now()}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

    </script>
</body>
</html>